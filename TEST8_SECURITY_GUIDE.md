# テスト8: セキュリティ系エラーパターン - 実施ガイド

## 📋 目的

パスワードリセット機能のセキュリティを確保するため、以下のエラーパターンが適切に処理されているかを確認します：

- ✅ 期限切れトークンへのアクセス
- ✅ 未ログイン状態での不正アクセス
- ✅ エラーメッセージの適切な表示
- ✅ 白画面やクラッシュが発生しない

---

## 🔵 8-1. 期限切れトークン

### 目的

パスワード再設定リンクの有効期限（通常24時間）が切れた場合、適切なエラーメッセージが表示されることを確認します。

### 手順

#### 方法A: 古いメールのURLを使用（推奨）

1. **古いパスワード再設定メールを探す**
   - 24時間以上前に送信されたパスワード再設定メールを探す
   - または、以前に送信したメールのURLをコピーしておく

2. **古いURLにアクセス**
   - メール内のリンクをクリック
   - または、URLをブラウザのアドレスバーに直接貼り付けてアクセス

3. **エラー表示を確認**
   - 画面にエラーメッセージが表示されることを確認

#### 方法B: エラーパラメータ付きURLでテスト

1. **エラーパラメータ付きURLを作成**
   - ブラウザのアドレスバーに以下を入力：
     ```
     http://localhost:3001/auth/reset-password?error=expired&error_code=otp_expired&error_description=This+link+has+expired
     ```

2. **エラー表示を確認**
   - 画面にエラーメッセージが表示されることを確認

#### 方法C: フラグメント内のエラーパラメータでテスト

1. **フラグメント内エラーパラメータ付きURLを作成**
   - ブラウザのアドレスバーに以下を入力：
     ```
     http://localhost:3001/auth/reset-password#error=expired&error_code=otp_expired&error_description=This+link+has+expired
     ```

2. **エラー表示を確認**
   - 画面にエラーメッセージが表示されることを確認

### 期待結果

- ✅ **適切なエラーメッセージが表示される**：
  ```
  リンクの有効期限が切れています。もう一度パスワード再設定メールを送信してください。
  ```
  または
  ```
  このリンクは既に使用済みか、無効です。新しいパスワード再設定メールを送信してください。
  ```

- ✅ **エラーで白画面にならない**
  - 画面が正常に表示される
  - ロゴやフォームのレイアウトが崩れていない

- ✅ **新しいパスワード再設定メールを送信するリンクが表示される**
  - 「パスワード再設定メールを送信する」ボタンまたはリンクが表示される
  - クリックすると `/auth/forgot-password` に遷移できる

- ✅ **パスワード入力フォームが表示されない**
  - エラー状態では、パスワード入力欄は表示されない
  - エラーメッセージと再送信リンクのみが表示される

### 確認方法

1. **ブラウザの開発者ツール（F12）→ Consoleタブ**
   - 以下のようなログが表示されることを確認：
     ```
     [ResetPassword] Error parameter found: {
       error: 'expired',
       errorCode: 'otp_expired',
       errorDescription: 'This link has expired'
     }
     ```
   - 赤いエラーメッセージが出ていないことを確認

2. **画面の表示確認**
   - エラーメッセージが赤枠で表示されている
   - 画面が崩れていない
   - 白画面になっていない

3. **再送信リンクの動作確認**
   - 「パスワード再設定メールを送信する」ボタンをクリック
   - `/auth/forgot-password` に遷移することを確認

---

## 🔵 8-2. 未ログイン状態での reset 直アクセス

### 目的

トークンなしで直接 `/auth/reset-password` にアクセスした場合、適切なエラーメッセージが表示されることを確認します。

### 手順

#### 方法A: シークレットモードでアクセス（推奨）

1. **シークレットモード（プライベートブラウジング）を開く**
   - Chrome: `Cmd+Shift+N` (Mac) または `Ctrl+Shift+N` (Windows)
   - Firefox: `Cmd+Shift+P` (Mac) または `Ctrl+Shift+P` (Windows)
   - Safari: `Cmd+Shift+N` (Mac)

2. **直接URLにアクセス**
   - アドレスバーに以下を入力：
     ```
     http://localhost:3001/auth/reset-password
     ```
   - Enterキーを押す

3. **エラー表示を確認**
   - 画面にエラーメッセージが表示されることを確認

#### 方法B: Cookieをクリアしてアクセス

1. **ブラウザのCookieをクリア**
   - 開発者ツール（F12）→ Applicationタブ → Cookies
   - または、ブラウザ設定からCookieをクリア

2. **直接URLにアクセス**
   - `http://localhost:3001/auth/reset-password` にアクセス

3. **エラー表示を確認**
   - 画面にエラーメッセージが表示されることを確認

#### 方法C: トークンなしのURLでアクセス

1. **トークンなしのURLでアクセス**
   - アドレスバーに以下を入力：
     ```
     http://localhost:3001/auth/reset-password?code=
     ```
   - または
     ```
     http://localhost:3001/auth/reset-password?access_token=
     ```

2. **エラー表示を確認**
   - 画面にエラーメッセージが表示されることを確認

### 期待結果

- ✅ **適切なエラーメッセージが表示される**：
  ```
  パスワード再設定リンクが見つかりません。新しいパスワード再設定メールを送信してください。
  ```
  または
  ```
  リンクの有効期限が切れているか、無効です。新しいパスワード再設定メールを送信してください。
  ```

- ✅ **白画面やエラーページにならない**
  - 画面が正常に表示される
  - ロゴやフォームのレイアウトが崩れていない

- ✅ **新しいパスワード再設定メールを送信するリンクが表示される**
  - 「パスワード再設定メールを送信する」ボタンまたはリンクが表示される
  - クリックすると `/auth/forgot-password` に遷移できる

- ✅ **パスワード入力フォームが表示されない**
  - エラー状態では、パスワード入力欄は表示されない
  - エラーメッセージと再送信リンクのみが表示される

### 確認方法

1. **ブラウザの開発者ツール（F12）→ Consoleタブ**
   - 以下のようなログが表示されることを確認：
     ```
     [ResetPassword] No valid token found in URL
     ```
   - 赤いエラーメッセージが出ていないことを確認

2. **Networkタブ**
   - Supabaseへの認証リクエストが送信されていないことを確認
   - 不要なAPIリクエストが発生していないことを確認

3. **画面の表示確認**
   - エラーメッセージが赤枠で表示されている
   - 画面が崩れていない
   - 白画面になっていない

---

## 📊 テスト結果の記録

各テストケースの結果を記録してください：

| テストケース | 期待結果 | 実際の結果 | 備考 |
|------------|---------|-----------|------|
| 8-1-A: 古いメールのURL | ✅ エラー表示 | ⏭️ 未実施 | エラーパラメータ付きURLで確認済み |
| 8-1-B: エラーパラメータ付きURL | ✅ エラー表示 | ✅ 合格 | 適切なエラーメッセージ表示、再送信ボタン表示 |
| 8-1-C: フラグメント内エラー | ✅ エラー表示 | ⏭️ 未実施 | エラーパラメータ付きURLで確認済み |
| 8-2-A: シークレットモード | ✅ エラー表示 | ✅ 合格 | 適切なエラーメッセージ表示、再送信ボタン表示 |
| 8-2-B: Cookieクリア | ✅ エラー表示 | ⏭️ 未実施 | シークレットモードで確認済み |
| 8-2-C: トークンなしURL | ✅ エラー表示 | ✅ 合格 | シークレットモードで確認済み |

---

## ✅ 合格条件

以下のすべてが満たされれば合格です：

- ✅ **期限切れトークンで適切なエラーメッセージが表示される**
- ✅ **未ログイン状態での直アクセスで適切なエラーメッセージが表示される**
- ✅ **エラーで白画面やクラッシュが発生しない**
- ✅ **再送信リンクが表示され、正常に動作する**
- ✅ **Consoleタブにエラーが出ていない**
- ✅ **セキュリティ上の問題がない**

---

## 🔍 トラブルシューティング

### エラーメッセージが表示されない場合

1. **Consoleタブを確認**
   - JavaScriptエラーが出ていないか確認
   - エラーログが出力されているか確認

2. **実装を確認**
   - `app/auth/reset-password/page.tsx` のエラーハンドリングを確認
   - `hasTokenError` の状態管理を確認

### 白画面になる場合

1. **Consoleタブでエラーを確認**
   - Reactのエラーが出ていないか確認
   - ネットワークエラーが出ていないか確認

2. **Networkタブを確認**
   - 必要なリソースが読み込まれているか確認
   - 404エラーが出ていないか確認

### 再送信リンクが動作しない場合

1. **リンクのURLを確認**
   - `/auth/forgot-password` に正しく遷移するか確認

2. **ページの実装を確認**
   - `app/auth/forgot-password/page.tsx` が存在するか確認

---

## 📝 注意事項

- **パスワード再設定URLは1回しか使用できません**
- 期限切れトークンのテストでは、実際に24時間以上経過したURLを使用するか、エラーパラメータを手動で追加してください
- シークレットモードを使用すると、Cookieが自動的にクリアされるため、テストが容易です
- エラーメッセージの文言は実装によって異なる場合がありますが、適切なエラーが表示されていれば問題ありません

---

## 🔗 関連ドキュメント

- [テスト8ガイド](./TEST8_GUIDE.md) - テスト8の全体ガイド
- [パスワードリセット実装](./app/auth/reset-password/page.tsx) - 実装コード


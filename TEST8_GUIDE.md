# テスト8: ログイン画面アップデート - 総合検証ガイド

## 📋 目的

以下のアップデートがすべて正常に動作しているかを、順番に検証します：

- ✅ パスワード表示チェックボックス
- ✅ パスワードリセット（メール送信 → 再設定）
- ✅ パスワード強度ルール（3種以上）
- ✅ password_updated_at の更新
- ✅ パスワード変更完了メール送信

---

## 🔵 0. 事前準備チェック

### 必須確認事項

以下をまず確認してください：

1. **ログイン可能なテストユーザー**
   - ✅ 最低2人分のテストユーザーが存在する
   - ✅ 各ユーザーのメールアドレスとパスワードが分かっている

2. **Supabase設定の確認**
   - ✅ Supabase Dashboardにアクセスできる
   - ✅ Auth → Users が見られる
   - ✅ `users` テーブルまたは `user_metadata` に `password_updated_at` を保存する想定になっている
   - ✅ Table Editor で `users` テーブルが見られる

3. **メール送信設定**
   - ✅ メール送信（本番 or テストSMTP）が少なくともログ上で確認できる状態
   - ✅ `.env.local` に `RESEND_API_KEY` が設定されている（推奨）

4. **開発環境**
   - ✅ 開発サーバーが起動している（`npm run dev`）
   - ✅ ブラウザで `http://localhost:3001` にアクセスできる

---

## 🔵 1. ログイン画面：パスワード表示チェック

### 手順

1. **ログイン画面にアクセス**
   - ブラウザで `http://localhost:3001/login` にアクセス

2. **パスワードを入力**
   - パスワード入力欄に `abcdEF12!` などを入力

3. **チェックボックスを操作**
   - 「✅ パスワードを表示する」にチェックを入れる
   - チェックを外す

### 期待結果

- ✅ 入力中のパスワードが**伏字から平文に切り替わる**
- ✅ チェックを外すと**再び伏字に戻る**
- ✅ 画面がリロードされない
- ✅ コンソールエラーなし
- ✅ チェックボックスが押しやすい位置にある

### 確認方法

1. ブラウザの開発者ツール（F12）→ Consoleタブを開く
2. エラーメッセージが出ていないことを確認

---

## 🔵 2. 「パスワードを忘れた方」導線

### 手順

1. **ログイン画面を開く**
   - `http://localhost:3001/login` にアクセス

2. **リンクをクリック**
   - ログイン画面下部の「パスワードを忘れた方」をクリック

3. **遷移を確認**
   - `/auth/forgot-password` に遷移することを確認

### 期待結果

- ✅ 以下の文言が表示される：
  ```
  CareBridge Hub に登録されているメールアドレスを入力してください。
  パスワード再設定用のURLをメールでお送りします。
  ```
- ✅ メール入力欄がある
- ✅ 「キャンセル」「送信する」ボタンがある
- ✅ 画面遷移がスムーズに行われる

---

## 🔵 3. パスワード再設定メール送信テスト

### 手順

1. **メールアドレスを入力**
   - 登録済みのメールアドレスを入力
   - 例: `kanjinagatomi99@gmail.com`

2. **送信ボタンをクリック**
   - 「送信する」ボタンをクリック

3. **メールを確認**
   - メールボックスを確認
   - または、Supabase Dashboard → Logs → Auth Logs を確認

### 期待結果

- ✅ **成功メッセージが表示される**：
  ```
  パスワード再設定のご案内メールを送信しました。
  ```
- ✅ Supabase Auth のログに `resetPasswordForEmail` が記録される
- ✅ 実メール or ログに再設定メールが届く
- ✅ **メール内に以下が含まれている**：
  - 再設定用URL
  - 有効期限24時間の注意書き

### 確認方法

1. **Supabase Dashboardで確認**
   - Dashboard → Authentication → Users
   - 対象ユーザーを選択
   - ログ履歴を確認

2. **メールボックスで確認**
   - メールが届いているか確認
   - 迷惑メールフォルダも確認

---

## 🔵 4. 再設定URLからのパスワードリセット画面

### 手順

1. **メール内のURLをクリック**
   - ステップ3で送信されたメールを開く
   - メール内のリンクをクリック

2. **遷移を確認**
   - `/auth/reset-password` に遷移することを確認

### 期待結果

- ✅ 画面に以下が表示される：
  - 「パスワードのリセット」
  - 「新しいパスワードを設定してください」
- ✅ パスワード入力欄がある
- ✅ **パスワードルールの説明が書いてある**：
  ```
  半角英小文字、半角英大文字、半角数字、記号のうち3種類以上を含む（記号は必須）
  ```
- ✅ 「送信する」ボタンがある
- ✅ 「パスワードを表示する」チェックボックスがある（実装されていれば）

---

## 🔵 5. パスワード強度ルールの検証

### ❌ NGパターン

#### テストケース 5-1: `abcdefgh`（小文字のみ）

**手順:**
1. パスワード入力欄に `abcdefgh` を入力
2. 「送信する」ボタンをクリック

**期待結果:**
- ✅ バリデーションエラーになる
- ✅ 送信されない
- ✅ エラーメッセージが表示される
- ✅ Supabase にリクエストが飛ばない

---

#### テストケース 5-2: `ABCDEFGH`（大文字のみ）

**手順:**
1. パスワード入力欄をクリア
2. `ABCDEFGH` を入力
3. 「送信する」ボタンをクリック

**期待結果:**
- ✅ テストケース5-1と同じエラーメッセージが表示される
- ✅ Networkタブにリクエストが送信されていない

---

#### テストケース 5-3: `12345678`（数字のみ）

**手順:**
1. パスワード入力欄をクリア
2. `12345678` を入力
3. 「送信する」ボタンをクリック

**期待結果:**
- ✅ テストケース5-1と同じエラーメッセージが表示される
- ✅ Networkタブにリクエストが送信されていない

---

#### テストケース 5-4: `abcABC12`（記号なし）

**手順:**
1. パスワード入力欄をクリア
2. `abcABC12` を入力
3. 「送信する」ボタンをクリック

**期待結果:**
- ✅ バリデーションエラーになる（記号が必須のため）
- ✅ エラーメッセージが表示される
- ✅ 送信されない

---

### ✅ OKパターン

#### テストケース 5-5: `abcDEF12!`（4種類すべて）

**手順:**
1. **新しいパスワード再設定URLを取得**（前回のテストで使用したURLは既に使用済み）
   - `/auth/forgot-password` から新しいメールを送信
2. パスワード入力欄に `abcDEF12!` を入力
3. 「送信する」ボタンをクリック

**期待結果:**
- ✅ Supabase Auth の `updateUser` が成功
- ✅ ローディングが終わり、成功メッセージ表示
- ✅ 自動でログイン画面（`/login?message=password-reset-success`）に遷移

---

#### テストケース 5-6: `Aa1!aaaa`（3種類以上）

**手順:**
1. **新しいパスワード再設定URLを取得**（必要に応じて）
2. パスワード入力欄に `Aa1!aaaa` を入力
3. 「送信する」ボタンをクリック

**期待結果:**
- ✅ テストケース5-5と同じ成功動作

---

### 確認方法

1. **ブラウザの開発者ツール（F12）→ Networkタブ**を開く
2. フィルターに `supabase` と入力
3. NGパターンではリクエストが送信されないことを確認
4. OKパターンでは `updateUser` リクエストが成功することを確認

---

## 🔵 6. password_updated_at の更新確認

### 手順

#### A) users テーブルを使っている場合

1. **Supabase Dashboardにアクセス**
   - https://supabase.com/dashboard
   - 該当プロジェクトを選択

2. **Table Editorを開く**
   - 左側メニュー → **Table Editor**
   - `users` テーブルを選択

3. **対象ユーザーを確認**
   - ステップ5でパスワードを変更したユーザーを検索
   - `password_updated_at` カラムを確認
   - **現在時刻近辺で更新されているか確認**

#### B) user_metadata の場合

1. **Supabase Dashboardにアクセス**
   - https://supabase.com/dashboard
   - 該当プロジェクトを選択

2. **Auth → Users を開く**
   - 左側メニュー → **Authentication** → **Users**
   - 対象ユーザーを選択

3. **user_metadata を確認**
   - `user_metadata.password_updated_at` が存在するか確認
   - **現在時刻に更新されているか確認**

### 期待結果

- ✅ 必ず何らかの形で更新履歴が残っている
- ✅ `password_updated_at` がパスワード変更時刻を反映している
- ✅ 時刻が現在時刻から数分以内である

### 確認のポイント

- パスワード変更前の時刻を記録しておき、変更後に更新されているか確認
- 複数回パスワードを変更して、都度更新されることを確認

---

## 🔵 7. パスワード変更完了メールの確認

### 手順

1. **パスワード更新を実行**
   - ステップ5でパスワード更新を完了させる

2. **メールボックスを確認**
   - 登録メールアドレスのメールボックスを確認
   - 迷惑メールフォルダも確認

3. **メール内容を確認**
   - 件名と本文を確認

### 期待結果

- ✅ **件名が正しい**：
  ```
  パスワード変更のご連絡（CareBridge Hub）
  ```
- ✅ **本文に以下のニュアンスが含まれる**：
  - 「パスワードが変更されました」または「パスワードの再設定が行われました」
  - 「心当たりがない場合はご連絡ください」または「第三者が不正にアクセスした可能性があります」
- ✅ **メール内に以下が含まれていない**：
  - ❌ トークン
  - ❌ パスワードそのもの
  - ❌ 認証情報

### 確認方法

1. **ブラウザの開発者ツール（F12）→ Networkタブ**
   - `/api/auth/password-changed-notify` リクエストが `200` で成功していることを確認

2. **Consoleタブ**
   - 以下のログが表示されていることを確認：
     ```
     [Email] ✅ Password changed email sent successfully
     ```

3. **Resend Dashboard（オプション）**
   - https://resend.com/emails にアクセス
   - 送信履歴を確認

---

## 🔵 8. セキュリティ系エラーパターン

### 8-1. 期限切れトークン

#### 手順

1. **古いURLを取得**
   - 以前に送信されたパスワード再設定メールのURLをコピー
   - または、24時間以上前に送信されたメールのURLを使用

2. **URLにアクセス**
   - 古いURLで `/auth/reset-password` に再アクセス

#### 期待結果

- ✅ 以下のような表示が出る：
  ```
  このリンクは有効期限が切れています。
  もう一度パスワード再設定を行ってください。
  ```
  または
  ```
  リンクの有効期限が切れているか、無効です。新しいパスワード再設定メールを送信してください。
  ```
- ✅ エラーで白画面にならない
- ✅ 新しいパスワード再設定メールを送信するリンクが表示される

---

### 8-2. 未ログイン状態での reset 直アクセス

#### 手順

1. **ログアウト状態を確認**
   - ブラウザのCookieをクリア
   - または、シークレットモードでアクセス

2. **直接アクセス**
   - 直接 `http://localhost:3001/auth/reset-password` にアクセス（トークンなし）

#### 期待結果

- ✅ 不正アクセスエラー or ログイン画面へ戻される
- ✅ 以下のような表示が出る：
  ```
  パスワード再設定リンクが見つかりません。新しいパスワード再設定メールを送信してください。
  ```
- ✅ 白画面やエラーページにならない

---

## 🔵 9. スマホ対応チェック

### 手順

1. **開発者ツールを開く**
   - ブラウザの開発者ツール（F12）を開く
   - デバイスツールバーアイコンをクリック（または `Cmd+Shift+M` / `Ctrl+Shift+M`）

2. **デバイスを選択**
   - デバイスを「iPhone 14」または「iPhone SE」に設定

3. **各画面を確認**
   - `/login` を確認
   - `/auth/forgot-password` を確認
   - `/auth/reset-password` を確認

### 期待結果

- ✅ **フォーム幅がはみ出ない**
  - 横スクロールが発生しない
  - すべての要素が画面内に収まっている
- ✅ **チェックボックス・ボタンが押しやすい**
  - タップ領域が十分にある（推奨: 44px × 44px以上）
  - 誤タップが起きにくい
- ✅ **テキストが重ならない**
  - ラベルと入力欄が適切に配置されている
  - エラーメッセージが正しく表示される
- ✅ **入力欄が使いやすい**
  - キーボードが適切に表示される
  - 入力欄が隠れない

---

## 🔵 10. コンソール最終チェック（最重要）

### 手順

1. **ブラウザの開発者ツールを開く**
   - `F12` を押す
   - または、右クリック → 「検証」

2. **Consoleタブを開く**
   - Consoleタブを選択

3. **すべてのテストを実行**
   - 上記のテスト1〜9をすべて実行した状態で確認

### 期待結果

ブラウザの Console に以下が**一切出ていないこと**：

- ❌ `Uncaught Runtime Error`
- ❌ `Supabase Auth Error`
- ❌ `undefined` / `null` 関連エラー
- ❌ `hydration error`
- ❌ 赤いエラーメッセージ（警告は許容）

### 確認方法

1. Consoleタブで「Errors」フィルターを選択
2. エラーメッセージがないことを確認
3. 警告（Warning）は機能に影響がなければ許容

---

## 📊 テスト結果の記録

各テスト項目の結果を記録してください：

| テスト項目 | 期待結果 | 実際の結果 | 備考 |
|----------|---------|-----------|------|
| 1. パスワード表示チェック | ✅ | ☐ | |
| 2. 「パスワードを忘れた方」導線 | ✅ | ☐ | |
| 3. パスワード再設定メール送信 | ✅ | ☐ | |
| 4. 再設定URLからの画面 | ✅ | ☐ | |
| 5-1. NG: `abcdefgh` | ✅ エラー | ☐ | |
| 5-2. NG: `ABCDEFGH` | ✅ エラー | ☐ | |
| 5-3. NG: `12345678` | ✅ エラー | ☐ | |
| 5-4. NG: `abcABC12` | ✅ エラー | ☐ | |
| 5-5. OK: `abcDEF12!` | ✅ 成功 | ☐ | |
| 5-6. OK: `Aa1!aaaa` | ✅ 成功 | ☐ | |
| 6. password_updated_at 更新 | ✅ | ☐ | |
| 7. パスワード変更完了メール | ✅ | ☐ | |
| 8-1. 期限切れトークン | ✅ エラー表示 | ☐ | |
| 8-2. 未ログイン直アクセス | ✅ エラー表示 | ☐ | |
| 9. スマホ対応 | ✅ | ☐ | |
| 10. コンソールエラーゼロ | ✅ | ☐ | |

---

## ✅ 合格条件（すべて満たせばOK）

以下のすべてが満たされれば合格です：

- ✅ **表示切替**: パスワード表示/非表示が正常に動作
- ✅ **メール送信**: パスワード再設定メールが正しく送信される
- ✅ **再設定成功**: パスワード再設定が正常に完了する
- ✅ **強度バリデーション**: NGパターンでエラー、OKパターンで成功
- ✅ **更新日時反映**: `password_updated_at` が正しく更新される
- ✅ **変更完了メール送信**: パスワード変更完了メールが送信される
- ✅ **エラー耐性**: 期限切れトークンや不正アクセスで適切なエラー表示
- ✅ **モバイル対応**: スマホサイズで正常に表示・操作できる
- ✅ **コンソールエラーゼロ**: ブラウザのConsoleにエラーが出ていない

**テスト8の判定: 上記の条件をすべて満たせば合格です！**

---

## 🐛 問題が見つかった場合

もし問題が見つかった場合は、以下を確認してください：

1. **ブラウザのConsoleタブ**でエラーメッセージを確認
2. **Networkタブ**でリクエスト/レスポンスの詳細を確認
3. **Supabase Dashboard**でログを確認
4. エラーのスクリーンショットを取得
5. 問題の詳細を記録

---

## 📝 注意事項

- **パスワード再設定URLは1回しか使用できません**
- 複数のテストケースを実施する場合は、それぞれ新しいメールを送信する必要があります
- テスト用ユーザーのパスワードが変更されるため、ログイン時に新しいパスワードを使用してください
- メール送信には時間がかかる場合があります（最大数分）
- Resendテストモードの場合、許可されたメールアドレスにのみメールが送信されます

---

## 🔗 関連ドキュメント

- [テスト5ガイド](./TEST5_GUIDE.md) - パスワード強度ルールの詳細検証
- [テスト7ガイド](./TEST7_GUIDE.md) - パスワード変更完了メールの詳細検証
- [Supabase SMTP設定ガイド](./SUPABASE_SMTP_SETUP_GUIDE.md) - メール送信設定


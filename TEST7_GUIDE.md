# テスト7: パスワード変更完了メールの確認 - 実施ガイド

## 📋 目的

パスワード変更時に、完了通知メールが正しく送信されているかを確認します。

## 🔍 現在の実装状況

**⚠️ 重要: 現在、パスワード変更完了メールの送信機能は実装されていません。**

現在の実装では、パスワード変更完了時に `/api/auth/password-changed-notify` エンドポイントが呼び出されますが、このエンドポイントは**ログ出力のみ**で、実際のメール送信は行われません。

---

## 📝 テスト手順（現在の実装での確認方法）

### ステップ1: パスワード更新を実行

1. `/auth/forgot-password` にアクセス
2. テスト用メールアドレスを入力して「送信する」をクリック
3. メール内のURLをクリックして `/auth/reset-password` にアクセス
4. 新しいパスワードを入力（例: `Test123!pass`）
5. 「送信する」をクリック
6. パスワード更新が成功し、ログイン画面にリダイレクトされることを確認

---

### ステップ2: コンソールログを確認

現在の実装では、メール送信の代わりにコンソールログが出力されます。

1. **ブラウザの開発者ツールを開く**（F12）
2. **Consoleタブ**を開く
3. パスワード更新を実行
4. コンソールに以下のようなログが表示されることを確認：

**フロントエンド側のログ（ブラウザのConsole）:**
```
[ResetPassword] Sending password changed notification email request... {
  userId: "...",
  email: "..."
}

[ResetPassword] Password changed notification response: {
  status: 200,
  data: {
    success: true,
    message: "Password changed notification logged (email sending not yet implemented)"
  }
}
```

**サーバー側のログ（Next.jsのターミナル）:**
```
[PasswordChangedNotify] Password changed notification requested: {
  userId: "...",
  email: "...",
  timestamp: "2025-12-08T..."
}
```

**重要:** ブラウザのConsoleタブとNext.jsのターミナルの両方でログが出力されます。

---

### ステップ3: Networkタブで確認

1. **ブラウザの開発者ツールを開く**（F12）
2. **Networkタブ**を開く
3. **フィルターを確認**
   - フィルター入力欄に `facilities` などのフィルターが入っている場合は、**フィルターをクリア**してください
   - または、フィルターに `password-changed-notify` と入力して該当リクエストのみを表示します
4. パスワード更新を実行（Networkタブを開いた状態で「送信する」をクリック）
5. `/api/auth/password-changed-notify` というリクエストが表示されることを確認
   - **Type**: `fetch` または `xhr`
   - **Status**: `200`
   - **Name**: `password-changed-notify`
6. リクエストをクリックして詳細を確認
   - **Request Payload** に `userId` と `email` が含まれていることを確認
   - **Response** に `success: true` と `message` が含まれていることを確認

---

### ステップ4: メールボックスを確認

現在の実装では**メールは送信されません**が、確認してください：

1. テスト用メールアドレスのメールボックスを確認
2. **パスワード変更完了メールは届いていない**ことを確認（現在の実装では期待される動作）

---

## ⚠️ 実装が必要な場合

テスト仕様で「パスワード変更完了メールが送信される」ことが求められている場合、実装を追加する必要があります。

### 実装方法の選択肢

1. **Supabase Edge Functions + SendGrid / SES / SMTP**
2. **Next.js API Route + SendGrid / SES / SMTP**
3. **外部メール送信サービス（Resend, Mailgun など）**

### 期待されるメール内容

**件名:**
```
パスワード変更のご連絡（CareBridge Hub）
```

**本文:**
```
CareBridge Hub にて、パスワードの再設定が行われました。

もしこのメールにお心当たりがない場合は、
第三者が不正にアクセスした可能性があります。
お手数ですが、至急システム管理者までご連絡ください。

本メールにお心当たりがある場合は、このままご利用いただけます。
```

### セキュリティ要件

- ✅ メール内に**トークンやパスワードそのもの**が含まれていない
- ✅ パスワード変更が行われた旨を通知
- ✅ 心当たりがない場合の対応方法を記載

---

## 📊 テスト結果の記録

| 確認項目 | 現在の実装 | 期待される動作 | 備考 |
|---------|-----------|--------------|------|
| メールが送信される | ❌ 未実装 | ✅ 送信される | |
| 件名が正しい | - | ✅ 確認 | |
| 本文が正しい | - | ✅ 確認 | |
| トークン/パスワードが含まれていない | - | ✅ 含まれていない | |
| コンソールログが出力される | ✅ 出力される | ✅ 出力される | |

---

## ✅ 合格条件（実装後）

以下のすべてが満たされれば合格です：

- ✅ パスワード変更後にメールが送信される
- ✅ 件名が「パスワード変更のご連絡（CareBridge Hub）」である
- ✅ 本文に以下の内容が含まれている：
  - パスワードが変更された旨
  - 心当たりがない場合の対応方法
- ✅ メール内にトークンやパスワードそのものが含まれていない
- ✅ セキュリティ上の問題がない

---

## 🔧 現在の実装での確認方法

実装が完了していない場合でも、以下を確認できます：

1. **APIエンドポイントが呼び出されているか**
   - Networkタブで `/api/auth/password-changed-notify` リクエストが送信されているか確認

2. **レスポンスが成功しているか**
   - レスポンスのステータスコードが `200` であることを確認

3. **コンソールログが出力されているか**
   - ブラウザのConsoleタブ、またはNext.jsのターミナルでログが出力されているか確認

---

## 📝 注意事項

- 現在の実装では、メール送信に失敗してもパスワード更新は成功したままです（エラーが無視されます）
- これは、パスワード更新が完了していることを優先する設計です
- メール送信機能を実装する場合は、メール送信サービスの設定が必要です

---

## 🐛 実装が必要な場合

実装が必要な場合は、以下を検討してください：

1. **メール送信サービスの選択**
   - Resend（推奨）: 簡単に始められる
   - SendGrid: 実績豊富
   - AWS SES: AWS環境の場合
   - Supabase SMTP: SupabaseのSMTP設定を使用

2. **実装箇所**
   - `app/api/auth/password-changed-notify/route.ts` を修正

3. **環境変数の設定**
   - メール送信サービス用のAPIキーを設定

実装が必要な場合は、お知らせください。実装を追加します。


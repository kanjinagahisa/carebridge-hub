# マイグレーション実行方法の比較

## 質問への回答

### Q1: 018まで実行済みの場合、`docs/run-all-migrations.sql`を実行しても問題ないか？

**回答: 技術的には問題ありませんが、推奨しません。**

理由：
- `docs/run-all-migrations.sql`には001〜064がすべて含まれています
- 001〜018を再実行すると、以下のようなエラーや警告が発生する可能性があります：
  - `relation "facilities" already exists`（テーブルが既に存在する）
  - `policy "Users can view facilities they belong to" already exists`（ポリシーが既に存在する）
  - ただし、多くのマイグレーションは`IF NOT EXISTS`や`DROP IF EXISTS`を使用しているため、エラーで停止することは少ないです

**推奨: `docs/run-migrations-019-to-064.sql`を使用してください**

### Q2: 個別実行と一括実行のデメリットは？

## 個別実行のメリット・デメリット

### メリット
- ✅ 各マイグレーションの結果を個別に確認できる
- ✅ エラーが発生した場合、どのマイグレーションでエラーが発生したかが明確
- ✅ 一部のマイグレーションをスキップできる
- ✅ 検証クエリ（SELECT文）の結果を個別に確認できる

### デメリット
- ❌ 時間がかかる（64個を1つずつ実行する必要がある）
- ❌ 手順が煩雑（各マイグレーションファイルを開いて、コピー&ペーストを繰り返す）
- ❌ 実行順序を間違える可能性がある

## 一括実行のメリット・デメリット

### メリット
- ✅ 1回の実行で完了（時間の節約）
- ✅ 手順が簡単（1つのファイルをコピー&ペーストするだけ）
- ✅ 実行順序が保証される（ファイル内で順番に結合されている）

### デメリット
- ❌ エラーが発生した場合、どのマイグレーションでエラーが発生したかを特定する必要がある
- ❌ 一部のマイグレーションをスキップできない
- ❌ 検証クエリ（SELECT文）の結果が混在する（最後のクエリの結果のみが表示される）
- ❌ 既に実行済みのマイグレーションを再実行すると、不要な処理が発生する可能性がある

## 推奨される実行方法

### 現在の状況（018まで実行済み）

**推奨: `docs/run-migrations-019-to-064.sql`を使用**

1. `docs/run-migrations-019-to-064.sql`を開く
2. 内容をすべてコピー
3. Supabase の SQL Editor で実行
4. エラーが発生した場合は、エラーメッセージとファイル内のコメント（`-- Migration: XXX_xxx.sql`）で、どのマイグレーションでエラーが発生したかを特定

### 初回実行の場合

**推奨: `docs/run-all-migrations.sql`を使用**

1. `docs/run-all-migrations.sql`を開く
2. 内容をすべてコピー
3. Supabase の SQL Editor で実行
4. エラーが発生した場合は、エラーメッセージとファイル内のコメントで、どのマイグレーションでエラーが発生したかを特定

## エラーが発生した場合の対処

### エラーメッセージの確認

エラーメッセージには、通常以下の情報が含まれます：
- エラーの種類（例: `relation already exists`, `syntax error`）
- エラーが発生した行番号

### どのマイグレーションでエラーが発生したかの特定

1. エラーメッセージに表示されている行番号を確認
2. `docs/run-migrations-019-to-064.sql`を開く
3. 該当する行番号の近くにあるコメント（`-- Migration: XXX_xxx.sql`）を確認
4. 該当するマイグレーションファイルを個別に確認

### エラーの種類別の対処

#### `relation already exists`
- テーブルや関数が既に存在する場合に発生
- 多くのマイグレーションは`IF NOT EXISTS`を使用しているため、通常は問題ありません
- エラーで停止した場合は、該当するマイグレーションファイルを個別に確認してください

#### `policy already exists`
- RLSポリシーが既に存在する場合に発生
- 多くのマイグレーションは`DROP POLICY IF EXISTS`を使用しているため、通常は問題ありません
- エラーで停止した場合は、該当するマイグレーションファイルを個別に確認してください

#### `syntax error`
- SQL構文エラーの場合に発生
- エラーメッセージに表示されている行番号を確認し、該当するマイグレーションファイルを個別に確認してください

#### `permission denied`
- 権限が不足している場合に発生
- 権限付与マイグレーション（例: `017_grant_permissions_to_anon_role.sql`）が正しく実行されているか確認してください

## まとめ

| 項目 | 個別実行 | 一括実行（019〜064） | 一括実行（001〜064） |
|------|---------|---------------------|---------------------|
| 時間 | 長い | 短い | 短い |
| 手順 | 煩雑 | 簡単 | 簡単 |
| エラー特定 | 容易 | やや困難 | やや困難 |
| 既存データへの影響 | 少ない | 少ない | やや多い（再実行） |
| **推奨度（018まで実行済み）** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ |

**結論: 018まで実行済みの場合は、`docs/run-migrations-019-to-064.sql`を使用することを強く推奨します。**










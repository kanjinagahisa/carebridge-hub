# ğŸ§© CareBridge Hub â€” æœ¬ç•ªï¼ãƒ­ãƒ¼ã‚«ãƒ«æ··ç·šçŠ¶æ…‹ã®è¨ºæ–­ï¼†å¾©æ—§ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ ç›®æ¬¡

1. [ã‚¹ãƒ†ãƒƒãƒ—0: å‰æã®å…±æœ‰](#ã‚¹ãƒ†ãƒƒãƒ—0-å‰æã®å…±æœ‰)
2. [ã‚¹ãƒ†ãƒƒãƒ—1: ç’°å¢ƒå¤‰æ•°ã¾ã‚ã‚Šã®ç¢ºèªï¼ˆã‚³ãƒ¼ãƒ‰å´ï¼‰](#ã‚¹ãƒ†ãƒƒãƒ—1-ç’°å¢ƒå¤‰æ•°ã¾ã‚ã‚Šã®ç¢ºèªã‚³ãƒ¼ãƒ‰å´)
3. [ã‚¹ãƒ†ãƒƒãƒ—2: Vercel æœ¬ç•ªãŒã©ã“ã‚’è¦‹ã¦ã„ã‚‹ã‹ã®ç¢ºèªæ¡ˆå†…](#ã‚¹ãƒ†ãƒƒãƒ—2-vercel-æœ¬ç•ªãŒã©ã“ã‚’è¦‹ã¦ã„ã‚‹ã‹ã®ç¢ºèªæ¡ˆå†…)
4. [ã‚¹ãƒ†ãƒƒãƒ—3: Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ DB ã‚¹ã‚­ãƒ¼ãƒã®"è¦‹ãˆã‚‹åŒ–"](#ã‚¹ãƒ†ãƒƒãƒ—3-supabase-ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨-db-ã‚¹ã‚­ãƒ¼ãƒã®è¦‹ãˆã‚‹åŒ–)
5. [ã‚¹ãƒ†ãƒƒãƒ—4: migrations ã¨å®Ÿ DB ã®æ•´åˆãƒã‚§ãƒƒã‚¯](#ã‚¹ãƒ†ãƒƒãƒ—4-migrations-ã¨å®Ÿ-db-ã®æ•´åˆãƒã‚§ãƒƒã‚¯)
6. [ã‚¹ãƒ†ãƒƒãƒ—5: ç¾çŠ¶ã®"ãƒãƒˆãƒªã‚¯ã‚¹ã¾ã¨ã‚"](#ã‚¹ãƒ†ãƒƒãƒ—5-ç¾çŠ¶ã®ãƒãƒˆãƒªã‚¯ã‚¹ã¾ã¨ã‚)
7. [ã‚¹ãƒ†ãƒƒãƒ—6: ä»Šå¾Œã®æ•´ç†æ–¹é‡ï¼ˆææ¡ˆã ã‘ï¼‰](#ã‚¹ãƒ†ãƒƒãƒ—6-ä»Šå¾Œã®æ•´ç†æ–¹é‡ææ¡ˆã ã‘)

---

## ã‚¹ãƒ†ãƒƒãƒ—0: å‰æã®å…±æœ‰

### ç¾åœ¨ã®æƒ³å®šçŠ¶æ³

ä»¥ä¸‹ã®æƒ…å ±ã‚’æ•´ç†ã—ã¦ãã ã•ã„ï¼š

- **Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°**: ä½•å€‹ã‚ã‚‹æƒ³å®šã‹ï¼ˆä¾‹: devç”¨1å€‹ã€prodç”¨1å€‹ï¼‰
- **Vercel ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°**: ä½•å€‹ã‚ã‚‹æƒ³å®šã‹ï¼ˆä¾‹: æœ¬ç•ªç”¨1å€‹ã®ã¿ã€ã¾ãŸã¯ staging + productionï¼‰
- **ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º**: ã©ã® Supabase ã‚’ä½¿ã£ã¦ã„ã‚‹æƒ³å®šã ã£ãŸã‹ï¼ˆä¾‹: `carebridge-hub-dev`ï¼‰

### ç¢ºèªäº‹é …

1. Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’ç¢ºèª
2. å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åå‰ã¨ã€URLã®ä¸€éƒ¨ï¼ˆ`https://xxx.supabase.co` ã® `xxx` éƒ¨åˆ†ï¼‰ã‚’ãƒ¡ãƒ¢
3. Vercel ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’ç¢ºèª

---

## ã‚¹ãƒ†ãƒƒãƒ—1: ç’°å¢ƒå¤‰æ•°ã¾ã‚ã‚Šã®ç¢ºèªï¼ˆã‚³ãƒ¼ãƒ‰å´ï¼‰

### 1-1. ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª

ãƒªãƒã‚¸ãƒˆãƒªå†…ã§ç¢ºèªã—ãŸçµæœï¼š

- âœ… `.env.local` - `.gitignore` ã§é™¤å¤–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å­˜åœ¨ã™ã‚‹å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ã®ã¿å­˜åœ¨
- âœ… `.env` - `.gitignore` ã§é™¤å¤–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å­˜åœ¨ã™ã‚‹å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ã®ã¿å­˜åœ¨
- âŒ `.env.development` - è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
- âŒ `.env.production` - è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
- âœ… `next.config.js` - å­˜åœ¨ã—ã¾ã™ï¼ˆSupabase ã®ç”»åƒãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã®ã¿ï¼‰

### 1-2. ã‚³ãƒ¼ãƒ‰å†…ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•°

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰å†…ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ Supabase é–¢é€£ã®ç’°å¢ƒå¤‰æ•°ï¼š

| ç’°å¢ƒå¤‰æ•°å | ä½¿ç”¨ç®‡æ‰€ | èª¬æ˜ |
|-----------|---------|------|
| `NEXT_PUBLIC_SUPABASE_URL` | `lib/supabase/client.ts`<br>`lib/supabase/server.ts`<br>`lib/supabase/middleware.ts` | Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® URL |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | `lib/supabase/client.ts`<br>`lib/supabase/server.ts`<br>`lib/supabase/middleware.ts` | Supabase ã®åŒ¿åã‚­ãƒ¼ï¼ˆå…¬é–‹å¯èƒ½ï¼‰ |
| `SUPABASE_SERVICE_ROLE_KEY` | `lib/supabase/admin.ts` | Supabase ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚­ãƒ¼ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿ã€RLS ã‚’ãƒã‚¤ãƒ‘ã‚¹ï¼‰ |

### 1-3. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ç¢ºèªæ–¹æ³•

**âš ï¸ é‡è¦: ç’°å¢ƒå¤‰æ•°ã®å€¤ï¼ˆURLã‚„ã‚­ãƒ¼ï¼‰ã¯çµ¶å¯¾ã«ãƒ•ãƒ«ã§è¡¨ç¤ºã—ãªã„ã§ãã ã•ã„**

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã§ãã¾ã™ï¼š

```bash
# .env.local ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
cat .env.local | grep SUPABASE

# ã¾ãŸã¯ã€å€¤ã®ä¸€éƒ¨ã ã‘ã‚’è¡¨ç¤ºï¼ˆãƒã‚¹ã‚¯ï¼‰
cat .env.local | grep SUPABASE | sed 's/\(https:\/\/\)\([^.]*\)\.\(.*\)/\1***.\3/g'
```

**ç¢ºèªã™ã¹ããƒã‚¤ãƒ³ãƒˆï¼š**

1. `.env.local` ã« `NEXT_PUBLIC_SUPABASE_URL` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
2. ãã® URL ã® `xxx` éƒ¨åˆ†ï¼ˆ`https://xxx.supabase.co`ï¼‰ã‚’ãƒ¡ãƒ¢
3. ãã® URL ãŒ Supabase ã®ã©ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾å¿œã—ã¦ã„ã‚‹ã‹ç¢ºèª

---

## ã‚¹ãƒ†ãƒƒãƒ—2: Vercel æœ¬ç•ªãŒã©ã“ã‚’è¦‹ã¦ã„ã‚‹ã‹ã®ç¢ºèªæ¡ˆå†…

### 2-1. Vercel ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®ç¢ºèªæ‰‹é †

ä»¥ä¸‹ã®æ‰‹é †ã§ã€Vercel æœ¬ç•ªç’°å¢ƒãŒã©ã® Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼š

#### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] **ã‚¹ãƒ†ãƒƒãƒ—1**: Vercel ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆhttps://vercel.comï¼‰ã«ãƒ­ã‚°ã‚¤ãƒ³
- [ ] **ã‚¹ãƒ†ãƒƒãƒ—2**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‹ã‚‰ã€ŒCareBridge Hubã€æœ¬ç•ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã
- [ ] **ã‚¹ãƒ†ãƒƒãƒ—3**: å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒSettingsã€ã‚’ã‚¯ãƒªãƒƒã‚¯
- [ ] **ã‚¹ãƒ†ãƒƒãƒ—4**: ã€ŒEnvironment Variablesã€ã‚’ã‚¯ãƒªãƒƒã‚¯
- [ ] **ã‚¹ãƒ†ãƒƒãƒ—5**: ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªï¼š
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY`ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰

#### ç¢ºèªçµæœã®è¨˜éŒ²

ä»¥ä¸‹ã®æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ã“ã®ã‚¬ã‚¤ãƒ‰ã«è¿½è¨˜ã—ã¦ãã ã•ã„ï¼š

```
ã€Vercel æœ¬ç•ªç’°å¢ƒã®ç’°å¢ƒå¤‰æ•°ã€‘
- NEXT_PUBLIC_SUPABASE_URL: https://xxx.supabase.coï¼ˆxxxéƒ¨åˆ†ã®ã¿ï¼‰
- NEXT_PUBLIC_SUPABASE_ANON_KEY: è¨­å®šã•ã‚Œã¦ã„ã‚‹ï¼ˆå…ˆé ­10æ–‡å­—ã®ã¿: eyJ...ï¼‰
- SUPABASE_SERVICE_ROLE_KEY: è¨­å®šã•ã‚Œã¦ã„ã‚‹ / è¨­å®šã•ã‚Œã¦ã„ãªã„
```

### 2-2. Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã®ç…§åˆ

1. Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³
2. å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã€ŒSettingsã€â†’ã€ŒAPIã€ã‚’é–‹ã
3. ã€ŒProject URLã€ã‚’ç¢ºèª
4. Vercel ã® `NEXT_PUBLIC_SUPABASE_URL` ã¨ä¸€è‡´ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç‰¹å®š

**ç…§åˆçµæœã®è¨˜éŒ²ï¼š**

| Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå | URLï¼ˆxxxéƒ¨åˆ†ï¼‰ | Vercel æœ¬ç•ªãŒå‚ç…§ã—ã¦ã„ã‚‹ã‹ |
|------------------------|---------------|---------------------------|
| ï¼ˆä¾‹ï¼‰carebridge-hub-prod | xxx-prod | âœ… ã¯ã„ |
| ï¼ˆä¾‹ï¼‰carebridge-hub-dev | xxx-dev | âŒ ã„ã„ãˆ |

---

## ã‚¹ãƒ†ãƒƒãƒ—3: Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ DB ã‚¹ã‚­ãƒ¼ãƒã®"è¦‹ãˆã‚‹åŒ–"

### 3-1. å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã®ç¢ºèª

**å„ Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆæœ¬ç•ªå€™è£œãƒ»é–‹ç™ºå€™è£œï¼‰ã§ã€ä»¥ä¸‹ã® SQL ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š**

```sql
SELECT 
  table_name,
  table_type
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_type = 'BASE TABLE'
ORDER BY table_name;
```

**å®Ÿè¡Œæ–¹æ³•ï¼š**

1. Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
2. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ ã€ŒSQL Editorã€ã‚’é–‹ã
3. ã€ŒNew Queryã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ä¸Šè¨˜ã® SQL ã‚’è²¼ã‚Šä»˜ã‘ã¦å®Ÿè¡Œ
5. çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€ä»¥ä¸‹ã®è¡¨ã«è¨˜å…¥

**çµæœè¨˜éŒ²ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ï¼š**

| ãƒ†ãƒ¼ãƒ–ãƒ«å | æœ¬ç•ªå€™è£œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆA | é–‹ç™ºå€™è£œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆB | æƒ³å®šï¼ˆmigrations ã‹ã‚‰ï¼‰ |
|-----------|---------------------|---------------------|----------------------|
| attachments | âœ… / âŒ | âœ… / âŒ | âœ… (migration 041) |
| client_documents | âœ… / âŒ | âœ… / âŒ | âœ… (migration 026) |
| clients | âœ… / âŒ | âœ… / âŒ | âœ… (migration 001) |
| facilities | âœ… / âŒ | âœ… / âŒ | âœ… (migration 001) |
| group_members | âœ… / âŒ | âœ… / âŒ | âœ… (migration 001) |
| groups | âœ… / âŒ | âœ… / âŒ | âœ… (migration 001) |
| invite_codes | âœ… / âŒ | âœ… / âŒ | âœ… (migration 003) |
| post_reads | âœ… / âŒ | âœ… / âŒ | âœ… (migration 001) |
| post_reactions | âœ… / âŒ | âœ… / âŒ | âœ… (migration 001) |
| posts | âœ… / âŒ | âœ… / âŒ | âœ… (migration 001) |
| user_facility_roles | âœ… / âŒ | âœ… / âŒ | âœ… (migration 001) |
| users | âœ… / âŒ | âœ… / âŒ | âœ… (migration 001) |

### 3-2. ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ ç¢ºèª

**è¨ºæ–­ç”¨ SQL ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š**

`docs/diagnosis-production-local-mix.sql` ãƒ•ã‚¡ã‚¤ãƒ«ã«ã€å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ æ§‹é€ ã‚’ç¢ºèªã™ã‚‹ SQL ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

**å®Ÿè¡Œæ‰‹é †ï¼š**

1. `docs/diagnosis-production-local-mix.sql` ã‚’é–‹ã
2. å„ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨ã® SQL ã‚¯ã‚¨ãƒªã‚’ã‚³ãƒ”ãƒ¼
3. æœ¬ç•ªå€™è£œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å®Ÿè¡Œ â†’ çµæœã‚’ä¿å­˜
4. é–‹ç™ºå€™è£œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å®Ÿè¡Œ â†’ çµæœã‚’ä¿å­˜
5. çµæœã‚’æ¯”è¼ƒã—ã¦ã€å·®åˆ†ã‚’ç¢ºèª

**ç¢ºèªã™ã¹ãä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼š**

- `clients` - åˆ©ç”¨è€…ãƒ†ãƒ¼ãƒ–ãƒ«
- `client_documents` - åˆ©ç”¨è€…æ›¸é¡ãƒ†ãƒ¼ãƒ–ãƒ«
- `groups` - ã‚°ãƒ«ãƒ¼ãƒ—ãƒ†ãƒ¼ãƒ–ãƒ«
- `posts` - æŠ•ç¨¿ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ`client_id` ã‚«ãƒ©ãƒ ã®æœ‰ç„¡ã‚’ç¢ºèªï¼‰
- `post_reads` - æŠ•ç¨¿æ—¢èª­ãƒ†ãƒ¼ãƒ–ãƒ«
- `post_reactions` - æŠ•ç¨¿ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«
- `user_facility_roles` - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–½è¨­å½¹å‰²ãƒ†ãƒ¼ãƒ–ãƒ«
- `facilities` - æ–½è¨­ãƒ†ãƒ¼ãƒ–ãƒ«
- `attachments` - æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«

**å·®åˆ†ç¢ºèªã®ãƒã‚¤ãƒ³ãƒˆï¼š**

1. **`posts` ãƒ†ãƒ¼ãƒ–ãƒ«**: `client_id` ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã™ã‚‹ã‹ï¼ˆmigration 036 ã§è¿½åŠ ï¼‰
2. **`posts` ãƒ†ãƒ¼ãƒ–ãƒ«**: `group_id` ãŒ nullable ã‹ï¼ˆmigration 036 ã§å¤‰æ›´ï¼‰
3. **`client_documents` ãƒ†ãƒ¼ãƒ–ãƒ«**: å­˜åœ¨ã™ã‚‹ã‹ï¼ˆmigration 026 ã§ä½œæˆï¼‰
4. **`attachments` ãƒ†ãƒ¼ãƒ–ãƒ«**: å­˜åœ¨ã™ã‚‹ã‹ï¼ˆmigration 001 ã§ä½œæˆã€ã¾ãŸã¯å¾Œã§è¿½åŠ ï¼‰

---

## ã‚¹ãƒ†ãƒƒãƒ—4: migrations ã¨å®Ÿ DB ã®æ•´åˆãƒã‚§ãƒƒã‚¯

### 4-1. Migration ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

ãƒªãƒã‚¸ãƒˆãƒªå†…ã® `supabase/migrations/` ãƒ•ã‚©ãƒ«ãƒ€ã«ã¯ã€**65å€‹ã® migration ãƒ•ã‚¡ã‚¤ãƒ«**ãŒå­˜åœ¨ã—ã¾ã™ã€‚

**ä¸»è¦ãª migration ã®è¦ç´„ï¼š**

| Migration | ãƒ•ã‚¡ã‚¤ãƒ«å | ä¸»ãªå¤‰æ›´å†…å®¹ |
|-----------|-----------|------------|
| 001 | `001_initial_schema.sql` | åˆæœŸã‚¹ã‚­ãƒ¼ãƒä½œæˆï¼ˆfacilities, users, clients, groups, posts ãªã©ï¼‰ |
| 002 | `002_rls_policies.sql` | RLS ãƒãƒªã‚·ãƒ¼ã®åˆæœŸè¨­å®š |
| 003 | `003_invite_codes.sql` | æ‹›å¾…ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ |
| 026 | `026_create_client_documents.sql` | `client_documents` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ |
| 036 | `036_add_client_id_to_posts.sql` | `posts` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `client_id` ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã€`group_id` ã‚’ nullable ã« |
| 041 | `041_create_attachments_storage_bucket.sql` | Storage ãƒã‚±ãƒƒãƒˆã®ãƒãƒªã‚·ãƒ¼è¨­å®šï¼ˆãƒã‚±ãƒƒãƒˆè‡ªä½“ã¯æ‰‹å‹•ä½œæˆï¼‰ |
| 049 | `049_fix_clients_facility_id.sql` | ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ï¼ˆç‰¹å®šã® facility_id ã®ä¿®æ­£ï¼‰ |

**å…¨ migration ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼š**

```
001_initial_schema.sql
002_rls_policies.sql
003_invite_codes.sql
004_facility_setup_policies.sql
005_fix_facility_insert_policy.sql
006_verify_policies.sql
007_recreate_facility_policy.sql
008_fix_policy_roles.sql
009_debug_auth_uid.sql
010_check_policy_details.sql
011_fix_facility_insert_policy_final.sql
012_fix_facility_insert_policy_remove_to_authenticated.sql
013_debug_facility_insert_policy.sql
014_fix_facility_insert_policy_using_service_role.sql
015_fix_facility_insert_policy_final.sql
016_grant_permissions_and_fix_policy.sql
017_grant_permissions_to_anon_role.sql
018_verify_permissions.sql
019_fix_facility_insert_policy_using_service_role.sql
020_check_current_policies.sql
021_fix_facility_insert_policy_for_anon.sql
022_fix_facility_insert_policy_drop_all.sql
023_verify_and_fix_policies.sql
024_fix_user_facility_roles_select_policy.sql
025_ensure_policy_applied.sql
026_create_client_documents.sql
027_client_documents_rls_policies.sql
028_extend_invite_codes.sql
029_invite_codes_rls_update.sql
030_facilities_update_policy.sql
031_facilities_anonymous_invite_policy.sql
032_fix_invite_codes_anonymous_policy.sql
033_fix_invite_codes_policy_conflict.sql
034_fix_invite_codes_authenticated_access.sql
035_facilities_authenticated_invite_policy.sql
036_add_client_id_to_posts.sql
037_update_posts_rls_for_clients.sql
038_update_post_reactions_rls_for_clients.sql
039_update_post_reads_rls_for_clients.sql
040_update_attachments_rls_for_clients.sql
041_create_attachments_storage_bucket.sql
042_simplified_attachments_storage_policy.sql
044_fix_storage_attachments_rls.sql
045_fix_storage_attachments_rls_v2.sql
046_fix_storage_attachments_rls_v3.sql
047_fix_post_reactions_rls_insert.sql
048_debug_post_reactions_rls.sql
049_fix_clients_facility_id.sql
050_diagnose_and_fix_clients_facility.sql
051_fix_clients_facility_direct.sql
052_verify_clients_facility_fix.sql
053_check_user_facilities.sql
054_check_existing_attachments.sql
055_fix_attachments_file_url.sql
056_debug_storage_upload.sql
057_fix_storage_upload_rls.sql
058_fix_storage_read_rls.sql
059_fix_post_reads_insert_rls.sql
060_diagnose_post_reads_rls.sql
061_simplify_post_reads_insert_rls.sql
062_diagnose_post_reads_insert_issue.sql
063_diagnose_storage_access.sql
064_fix_post_reactions_select_rls.sql
065_fix_invite_code_user_facility_roles_insert.sql
```

### 4-2. Supabase CLI ã®ä½¿ç”¨çŠ¶æ³ç¢ºèª

**ç¾åœ¨ã®çŠ¶æ³ï¼š**

- ãƒªãƒã‚¸ãƒˆãƒªå†…ã« `supabase/config.toml` ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
- ã“ã‚Œã¯ã€Supabase CLI ã‚’ä½¿ã£ãŸé€£æºãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒé«˜ã„ã§ã™

**ç¢ºèªæ–¹æ³•ï¼š**

```bash
# Supabase CLI ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
supabase --version

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒãƒªãƒ³ã‚¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
supabase status
```

**ã‚‚ã— Supabase CLI ã‚’ä½¿ã£ã¦ã„ãªã„å ´åˆï¼š**

- migrations ã¯ã€Œå‚è€ƒæƒ…å ±ã€ã¨ã—ã¦æ‰±ã„ã¾ã™
- å®Ÿéš›ã® DB ã‚¹ã‚­ãƒ¼ãƒã¨ migrations ã®æ•´åˆæ€§ã¯ã€æ‰‹å‹•ã§ SQL Editor ã‹ã‚‰ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

**ã‚‚ã— Supabase CLI ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆï¼š**

```bash
# é©ç”¨æ¸ˆã¿ migration ã®ç¢ºèª
supabase migration list

# æœªé©ç”¨ migration ã®ç¢ºèª
supabase db diff
```

### 4-3. æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã®æ‰‹é †

**æ‰‹å‹•ã§ã®ç¢ºèªæ–¹æ³•ï¼š**

1. **Migration 001 ã®ç¢ºèª**: `001_initial_schema.sql` ã‚’é–‹ãã€ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
2. **Migration 026 ã®ç¢ºèª**: `client_documents` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
3. **Migration 036 ã®ç¢ºèª**: `posts` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `client_id` ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
4. **Migration 041 ã®ç¢ºèª**: Storage ãƒã‚±ãƒƒãƒˆ `attachments` ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªï¼ˆSupabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ Storageï¼‰

**ç¢ºèªçµæœã®è¨˜éŒ²ï¼š**

| Migration | æœ¬ç•ªå€™è£œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆA | é–‹ç™ºå€™è£œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆB | æƒ³å®šçŠ¶æ…‹ |
|-----------|---------------------|---------------------|---------|
| 001 (åˆæœŸã‚¹ã‚­ãƒ¼ãƒ) | âœ… / âŒ | âœ… / âŒ | âœ… é©ç”¨æ¸ˆã¿ |
| 026 (client_documents) | âœ… / âŒ | âœ… / âŒ | âœ… é©ç”¨æ¸ˆã¿ |
| 036 (posts.client_id) | âœ… / âŒ | âœ… / âŒ | âœ… é©ç”¨æ¸ˆã¿ |
| 041 (storage bucket) | âœ… / âŒ | âœ… / âŒ | âœ… ä½œæˆæ¸ˆã¿ |

---

## ã‚¹ãƒ†ãƒƒãƒ—5: ç¾çŠ¶ã®"ãƒãƒˆãƒªã‚¯ã‚¹ã¾ã¨ã‚"

ä»¥ä¸‹ã®ãƒãƒˆãƒªã‚¯ã‚¹ã«ã€ã“ã‚Œã¾ã§ã®ç¢ºèªçµæœã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼š

### 5-1. Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§

| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå | URLï¼ˆxxxéƒ¨åˆ†ï¼‰ | æƒ³å®šå½¹å‰² | ãƒ†ãƒ¼ãƒ–ãƒ«æ•° | ä¸»ãªã‚«ãƒ©ãƒ æ§‹æˆ | å‚™è€ƒ |
|--------------|---------------|---------|-----------|--------------|------|
| ï¼ˆä¾‹ï¼‰carebridge-hub-prod | xxx-prod | æœ¬ç•ªå€™è£œ | 12 | posts ã« client_id ã‚ã‚Š | Vercel æœ¬ç•ªãŒå‚ç…§ |
| ï¼ˆä¾‹ï¼‰carebridge-hub-dev | xxx-dev | é–‹ç™ºå€™è£œ | 10 | posts ã« client_id ãªã— | ãƒ­ãƒ¼ã‚«ãƒ«ãŒå‚ç…§ |

### 5-2. ç’°å¢ƒå¤‰æ•°ã®å‚ç…§é–¢ä¿‚

| ç’°å¢ƒ | ä½¿ç”¨ã—ã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ« | Supabase URLï¼ˆxxxéƒ¨åˆ†ï¼‰ | å‚™è€ƒ |
|------|---------------------------|----------------------|------|
| Vercel æœ¬ç•ª | Vercel ã® Environment Variables | ï¼ˆè¨˜å…¥ï¼‰ | Settings â†’ Environment Variables ã§ç¢ºèª |
| ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º | `.env.local` | ï¼ˆè¨˜å…¥ï¼‰ | ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã§ç¢ºèª |

### 5-3. ã‚¹ã‚­ãƒ¼ãƒã®å·®åˆ†

| ãƒ†ãƒ¼ãƒ–ãƒ«/ã‚«ãƒ©ãƒ  | æœ¬ç•ªå€™è£œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆA | é–‹ç™ºå€™è£œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆB | æƒ³å®šï¼ˆmigrationsï¼‰ | å·®åˆ† |
|----------------|---------------------|---------------------|-------------------|------|
| `posts.client_id` | âœ… / âŒ | âœ… / âŒ | âœ… å­˜åœ¨ | ï¼ˆè¨˜å…¥ï¼‰ |
| `posts.group_id` | NOT NULL / NULL | NOT NULL / NULL | NULL (nullable) | ï¼ˆè¨˜å…¥ï¼‰ |
| `client_documents` ãƒ†ãƒ¼ãƒ–ãƒ« | âœ… / âŒ | âœ… / âŒ | âœ… å­˜åœ¨ | ï¼ˆè¨˜å…¥ï¼‰ |
| `attachments` ãƒ†ãƒ¼ãƒ–ãƒ« | âœ… / âŒ | âœ… / âŒ | âœ… å­˜åœ¨ | ï¼ˆè¨˜å…¥ï¼‰ |

---

## ã‚¹ãƒ†ãƒƒãƒ—6: ä»Šå¾Œã®æ•´ç†æ–¹é‡ï¼ˆææ¡ˆã ã‘ï¼‰

### 6-1. æœ¬ç•ª/é–‹ç™ºã®æ±ºå®šæ–¹é‡

**æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼š**

1. **æœ¬ç•ª Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é¸å®š**
   - Vercel æœ¬ç•ªãŒç¾åœ¨å‚ç…§ã—ã¦ã„ã‚‹ Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã€Œæœ¬ç•ªã€ã¨ã—ã¦å›ºå®š
   - ç†ç”±: æ—¢ã«æœ¬ç•ªç’°å¢ƒã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€åˆ‡ã‚Šæ›¿ãˆãƒªã‚¹ã‚¯ãŒé«˜ã„

2. **é–‹ç™º Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é¸å®š**
   - ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§ä½¿ç”¨ã—ã¦ã„ã‚‹ Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã€Œé–‹ç™ºã€ã¨ã—ã¦å›ºå®š
   - ã¾ãŸã¯ã€æ–°è¦ã«é–‹ç™ºç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ

3. **ã‚¹ã‚­ãƒ¼ãƒã®çµ±ä¸€æ–¹é‡**
   - **æœ¬ç•ª â†’ é–‹ç™º**: æœ¬ç•ªã®ã‚¹ã‚­ãƒ¼ãƒã‚’é–‹ç™ºã«é©ç”¨ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯åˆ¥ç®¡ç†ï¼‰
   - **é–‹ç™º â†’ æœ¬ç•ª**: é–‹ç™ºã§ãƒ†ã‚¹ãƒˆæ¸ˆã¿ã® migration ã‚’æœ¬ç•ªã«é©ç”¨ï¼ˆæ…é‡ã«ï¼‰

### 6-2. ã‚¹ã‚­ãƒ¼ãƒã‚ºãƒ¬ã®è§£æ¶ˆæ–¹é‡

**ã‚‚ã—ã‚¹ã‚­ãƒ¼ãƒã«ã‚ºãƒ¬ãŒã‚ã‚‹å ´åˆï¼š**

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³A: migrations ã«å¯„ã›ã‚‹ï¼ˆæ¨å¥¨ï¼‰

- é–‹ç™ºç’°å¢ƒã§ä¸è¶³ã—ã¦ã„ã‚‹ migration ã‚’é©ç”¨
- æœ¬ç•ªç’°å¢ƒã§ä¸è¶³ã—ã¦ã„ã‚‹ migration ã‚’é©ç”¨ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾Œï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚³ãƒ¼ãƒ‰ã¨ DB ã®æ•´åˆæ€§ãŒå–ã‚Œã‚‹
- ä»Šå¾Œã® migration ç®¡ç†ãŒå®¹æ˜“

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¿…é ˆï¼‰

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³B: å®Ÿ DB ã«å¯„ã›ã‚‹

- å®Ÿ DB ã®çŠ¶æ…‹ã‚’ migration ãƒ•ã‚¡ã‚¤ãƒ«ã«åæ˜ 

**ãƒ¡ãƒªãƒƒãƒˆ:**
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã—ãªã„

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚³ãƒ¼ãƒ‰ã¨ DB ã®æ•´åˆæ€§ãŒå–ã‚Œãªããªã‚‹
- ä»Šå¾Œã® migration ç®¡ç†ãŒå›°é›£

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³C: ä¸€åº¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ã‹ã‚‰ä¿®æ­£

- æœ¬ç•ªãƒ»é–‹ç™ºã¨ã‚‚ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—
- migrations ã«å¯„ã›ã‚‹æ–¹å‘ã§çµ±ä¸€

**æ¨å¥¨: ã‚ªãƒ—ã‚·ãƒ§ãƒ³C**

### 6-3. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆåˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§å®Ÿè¡Œï¼‰

ä»¥ä¸‹ã®æ‰‹é †ã‚’ã€**åˆ¥ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§å®Ÿè¡Œ**ã—ã¦ãã ã•ã„ï¼š

1. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—**
   - æœ¬ç•ª Supabase: Settings â†’ Database â†’ Backups
   - é–‹ç™º Supabase: Settings â†’ Database â†’ Backups

2. **ç’°å¢ƒå¤‰æ•°ã®æ•´ç†**
   - `.env.local.example` ã‚’ä½œæˆï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
   - `.env.local` ã‚’é–‹ç™ºç”¨ Supabase ã«è¨­å®š
   - Vercel æœ¬ç•ªã®ç’°å¢ƒå¤‰æ•°ã‚’æœ¬ç•ªç”¨ Supabase ã«è¨­å®š

3. **Migration ã®é©ç”¨**
   - é–‹ç™ºç’°å¢ƒã§ä¸è¶³ã—ã¦ã„ã‚‹ migration ã‚’é©ç”¨
   - æœ¬ç•ªç’°å¢ƒã§ä¸è¶³ã—ã¦ã„ã‚‹ migration ã‚’é©ç”¨ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾Œã€æ…é‡ã«ï¼‰

4. **æ•´åˆæ€§ã®ç¢ºèª**
   - å„ç’°å¢ƒã§ã‚¹ã‚­ãƒ¼ãƒã®æ•´åˆæ€§ã‚’ç¢ºèª
   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œç¢ºèª

---

## ğŸ“ ç¢ºèªçµæœã®è¨˜éŒ²ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

ä»¥ä¸‹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã€ç¢ºèªçµæœã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼š

```markdown
## ç¢ºèªçµæœ

### Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAï¼ˆæœ¬ç•ªå€™è£œï¼‰: xxx-prod
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆBï¼ˆé–‹ç™ºå€™è£œï¼‰: xxx-dev

### Vercel æœ¬ç•ªç’°å¢ƒ
- NEXT_PUBLIC_SUPABASE_URL: https://xxx.supabase.coï¼ˆxxxéƒ¨åˆ†ï¼‰
- å‚ç…§ã—ã¦ã„ã‚‹ Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼‰

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ
- .env.local ã® NEXT_PUBLIC_SUPABASE_URL: https://xxx.supabase.coï¼ˆxxxéƒ¨åˆ†ï¼‰
- å‚ç…§ã—ã¦ã„ã‚‹ Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼‰

### ã‚¹ã‚­ãƒ¼ãƒã®å·®åˆ†
- ï¼ˆè¨˜å…¥ï¼‰

### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- ï¼ˆè¨˜å…¥ï¼‰
```

---

## âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …

1. **ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€DB ã®å¤‰æ›´ã¯ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“**
2. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯å¿…ãšå–å¾—ã—ã¦ãã ã•ã„**
3. **æœ¬ç•ªç’°å¢ƒã¸ã®å¤‰æ›´ã¯ã€åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§æ…é‡ã«è¡Œã£ã¦ãã ã•ã„**
4. **ç’°å¢ƒå¤‰æ•°ã®å€¤ï¼ˆURLã‚„ã‚­ãƒ¼ï¼‰ã¯ã€ãƒ•ãƒ«ã§è¡¨ç¤ºã—ãªã„ã§ãã ã•ã„**

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [Supabase ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://supabase.com/docs)
- [Vercel ç’°å¢ƒå¤‰æ•°ã®è¨­å®š](https://vercel.com/docs/concepts/projects/environment-variables)
- [Next.js ç’°å¢ƒå¤‰æ•°](https://nextjs.org/docs/basic-features/environment-variables)







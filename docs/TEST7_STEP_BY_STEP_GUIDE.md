# テスト項目7: UI側ガード実装確認 - 手取り足取りガイド

## 📋 このガイドについて

このガイドでは、テスト項目7「UI側ガード実装確認」を**実際に操作しながら**進められるよう、各ステップを詳しく説明します。

**目標**: 施設に紐付けられていないユーザーが `/home` にアクセスした際に、自動的に `/setup/choose` にリダイレクトされることを確認する

---

## 🎯 全体の流れ（5分で理解）

1. **準備**: 施設に紐付けられていないテストユーザーを用意
2. **SQL確認**: そのユーザーが本当に施設に紐付けられていないことを確認
3. **ログイン**: そのユーザーでログイン
4. **アクセス**: `/home` にアクセスしてみる
5. **確認**: 自動的に `/setup/choose` にリダイレクトされることを確認
6. **正常系**: 正常なユーザーで動作確認

---

## 📝 ステップ1: テスト用ユーザーの準備

### 1-1. 方法を選ぶ

テスト用ユーザーを準備する方法は3つあります。**最も簡単な方法A**から始めましょう。

#### 方法A: 新規サインアップ（最も簡単・推奨）

**手順**:

1. **ブラウザでアプリを開く**
   - ローカル環境: `http://localhost:3000`
   - 本番環境: `https://carebridge-hub.vercel.app`

2. **サインアップページにアクセス**
   - ブラウザのアドレスバーに `/signup` を入力してEnter
   - または、ログイン画面から「アカウントを作成する」リンクをクリック

3. **新しいメールアドレスでサインアップ**
   - **メールアドレス**: テスト用の新しいメールアドレスを入力（例: `test-no-facility@example.com`）
   - **パスワード**: 強度要件を満たすパスワードを入力（例: `Test123!pass`）
   - **表示名**: 任意の名前を入力（例: `テストユーザー`）
   - **職種**: 任意の職種を選択

4. **「アカウントを作成」をクリック**

5. **メール確認**
   - 入力したメールアドレスに確認メールが届く
   - メール内のリンクをクリックしてメールアドレスを確認

6. **完了**
   - この時点で、`auth.users` にはユーザーが作成されているが、`user_facility_roles` には何も入っていない状態

**記録しておく情報**:
- ✅ **TEST_USER_EMAIL**: `test-no-facility@example.com`（実際に入力したメールアドレス）
- ✅ **TEST_USER_PASSWORD**: `Test123!pass`（実際に入力したパスワード）

---

#### 方法B: 既存ユーザーを確認（SQL使用）

既にサインアップ済みのユーザーがいる場合、そのユーザーが施設に紐付けられていないか確認します。

**手順**:

1. **Supabase Dashboardにアクセス**
   - https://supabase.com にログイン
   - プロジェクトを選択
   - 左側メニューから「SQL Editor」をクリック

2. **以下のSQLを実行**

```sql
-- 施設に紐付けられていないユーザーを確認
SELECT
  u.id,
  u.email,
  u.display_name,
  COUNT(ufr.id) AS facility_count
FROM auth.users u
LEFT JOIN users pu ON pu.id = u.id
LEFT JOIN user_facility_roles ufr ON ufr.user_id = u.id AND ufr.deleted = false
WHERE pu.deleted = false
GROUP BY u.id, u.email, u.display_name
HAVING COUNT(ufr.id) = 0
ORDER BY u.created_at DESC
LIMIT 10;
```

3. **結果を確認**
   - 結果が表示される（0件の場合は、方法Aで新規作成）
   - メールアドレスとIDを記録

**記録しておく情報**:
- ✅ **TEST_USER_EMAIL**: SQL結果から取得したメールアドレス
- ✅ **TEST_USER_ID**: SQL結果から取得したID（UUID形式）

---

### 1-2. ユーザーIDを取得（方法Bを使用した場合）

方法Bを使用した場合、ユーザーIDが必要です。

**手順**:

1. **Supabase Dashboard → SQL Editor**

2. **以下のSQLを実行**

```sql
-- メールアドレスからユーザーIDを取得
SELECT
  id,
  email,
  created_at
FROM auth.users
WHERE email = 'TEST_USER_EMAIL_HERE';  -- 実際のメールアドレスに置き換える
```

3. **結果を確認**
   - `id` の値をコピー（これが `TEST_USER_ID`）

**記録しておく情報**:
- ✅ **TEST_USER_ID**: SQL結果から取得したID

---

## 📝 ステップ2: SQLで施設紐付けが無いことを確認

このステップでは、**テスト用ユーザーが本当に施設に紐付けられていない**ことを確認します。

### 2-1. Supabase Dashboardにアクセス

1. **Supabase Dashboardを開く**
   - https://supabase.com にログイン
   - プロジェクトを選択

2. **SQL Editorを開く**
   - 左側メニューから「SQL Editor」をクリック
   - 「New query」をクリック

### 2-2. ユーザーが `auth.users` に存在するか確認

**手順**:

1. **以下のSQLをコピー**

```sql
-- テスト用ユーザーが auth.users に存在するか確認
SELECT
  id,
  email,
  created_at,
  last_sign_in_at
FROM auth.users
WHERE email = 'test-no-facility@example.com';  -- 実際のメールアドレスに置き換える
```

2. **メールアドレスを置き換える**
   - `'test-no-facility@example.com'` の部分を、実際のテスト用メールアドレスに置き換える

3. **「Run」ボタンをクリック**

4. **結果を確認**
   - ✅ **成功**: 1行の結果が表示される（ユーザーが存在する）
   - ❌ **失敗**: 0行の結果が表示される（ユーザーが存在しない → 方法Aでサインアップをやり直す）

**確認ポイント**:
- `id` が表示されている（これが `TEST_USER_ID`）
- `email` が正しいメールアドレスである
- `created_at` が表示されている

**記録**: ✅ ユーザーが `auth.users` に存在することを確認

---

### 2-3. `user_facility_roles` に紐付けが無いことを確認

**手順**:

1. **以下のSQLをコピー**

```sql
-- テスト用ユーザーの施設紐付けを確認
SELECT
  ufr.user_id,
  ufr.facility_id,
  ufr.role,
  ufr.deleted,
  ufr.created_at
FROM user_facility_roles ufr
WHERE ufr.user_id = '00000000-0000-0000-0000-000000000000'::uuid  -- 実際のユーザーIDに置き換える
  AND ufr.deleted = false;
```

2. **ユーザーIDを置き換える**
   - `'00000000-0000-0000-0000-000000000000'` の部分を、ステップ2-2で取得した `id` に置き換える
   - 例: `'a1b2c3d4-e5f6-7890-abcd-ef1234567890'::uuid`

3. **「Run」ボタンをクリック**

4. **結果を確認**
   - ✅ **成功**: **0行の結果**が表示される（施設に紐付けられていない）
   - ❌ **失敗**: 1行以上の結果が表示される（施設に紐付けられている → 別のユーザーを使用するか、SQLで紐付けを削除）

**確認ポイント**:
- 結果が **0行** であること
- エラーメッセージが表示されていないこと

**記録**: ✅ `user_facility_roles` に紐付けが無いことを確認（0件）

---

## 📝 ステップ3: テスト用ユーザーでログイン

このステップでは、テスト用ユーザーでログインします。

### 3-1. 既存のセッションをログアウト（必要に応じて）

**手順**:

1. **現在ログインしている場合**
   - ブラウザで `/menu` にアクセス
   - 「ログアウト」ボタンをクリック
   - ログイン画面に遷移することを確認

2. **既にログアウトしている場合**
   - このステップをスキップ

---

### 3-2. テスト用ユーザーでログイン

**手順**:

1. **ログインページにアクセス**
   - ブラウザのアドレスバーに `/login` を入力してEnter
   - または、既にログイン画面が表示されている場合

2. **メールアドレスとパスワードを入力**
   - **メールアドレス**: `test-no-facility@example.com`（実際のテスト用メールアドレス）
   - **パスワード**: `Test123!pass`（実際のテスト用パスワード）

3. **「ログイン」ボタンをクリック**

4. **ログイン成功を確認**
   - ✅ ログイン画面から遷移する
   - ✅ エラーメッセージが表示されない

**確認ポイント**:
- ログインが成功していること
- エラーメッセージが表示されていないこと

**記録**: ✅ テスト用ユーザーでログイン成功

---

## 📝 ステップ4: `/home` にアクセスしてリダイレクトを確認

このステップでは、**施設に紐付けられていないユーザーが `/home` にアクセスした際に、自動的に `/setup/choose` にリダイレクトされる**ことを確認します。

### 4-1. ブラウザの開発者ツールを開く（推奨）

**手順**:

1. **開発者ツールを開く**
   - **Windows/Linux**: `F12` キーを押す
   - **Mac**: `Cmd + Option + I` を押す
   - または、右クリック → 「検証」を選択

2. **Consoleタブを開く**
   - 開発者ツールが開いたら、「Console」タブをクリック
   - これで、ログメッセージを確認できるようになります

**確認ポイント**:
- 開発者ツールが開いていること
- Consoleタブが選択されていること

---

### 4-2. `/home` にアクセス

**手順**:

1. **ブラウザのアドレスバーに `/home` を入力**
   - アドレスバーをクリック
   - `/home` と入力
   - Enterキーを押す

2. **または、ログイン後に自動的に `/home` に遷移した場合**
   - そのまま確認を続ける

---

### 4-3. リダイレクトを確認

**期待される動作**:

1. **URLが自動的に変更される**
   - アドレスバーのURLが `/home` から `/setup/choose` に自動的に変更される
   - ページが再読み込みされる

2. **セットアップ画面が表示される**
   - 「施設のセットアップ」というタイトルが表示される
   - 「新しい施設を作成する」ボタンが表示される
   - 「または」という区切りが表示される
   - 「招待リンクで既存施設に参加する」ボタンが表示される

**確認ポイント**:
- ✅ アドレスバーのURLが `/setup/choose` になっている
- ✅ セットアップ画面が表示されている
- ✅ ホーム画面の内容（新着投稿など）が表示されていない

**記録**: ✅ `/home` にアクセスすると `/setup/choose` にリダイレクトされる

---

### 4-4. コンソールログを確認

**手順**:

1. **開発者ツールのConsoleタブを確認**
   - ステップ4-1で開いた開発者ツールのConsoleタブを見る

2. **以下のようなログが表示されていることを確認**

```
[HomePage] Starting...
[HomePage] Supabase client created
[HomePage] User authenticated: <USER_ID> <USER_EMAIL>
[HomePage] Fetching user facilities with admin client...
[HomePage] User has no facilities, redirecting to setup
```

**確認ポイント**:
- ✅ `[HomePage] User has no facilities, redirecting to setup` というログが表示されている
- ✅ エラーメッセージ（赤い文字）が表示されていない

**記録**: ✅ コンソールログに「User has no facilities, redirecting to setup」が表示される

---

## 📝 ステップ5: セットアップ画面の表示内容を確認

このステップでは、セットアップ画面が正しく表示されていることを確認します。

### 5-1. 画面の表示内容を確認

**表示されるべき内容**:

1. **タイトル**
   - ✅ 「施設のセットアップ」というテキストが表示されている

2. **ボタン1**
   - ✅ 「新しい施設を作成する」というボタンが表示されている
   - ✅ ボタンがクリック可能である

3. **区切り**
   - ✅ 「または」というテキストが表示されている

4. **ボタン2**
   - ✅ 「招待リンクで既存施設に参加する」というボタンが表示されている
   - ✅ ボタンがクリック可能である

**表示されないべき内容**:

- ❌ ホーム画面の内容（新着投稿、未読メッセージなど）
- ❌ エラーメッセージ（「アクセスできません」など）
- ❌ 空白の画面

**確認ポイント**:
- ✅ 上記の内容がすべて表示されている
- ✅ エラーメッセージが表示されていない

**記録**: ✅ セットアップ画面が正しく表示される

---

### 5-2. ボタンの動作を確認（オプション）

**手順**:

1. **「新しい施設を作成する」ボタンをクリック**
   - `/setup/create` に遷移することを確認

2. **ブラウザの戻るボタンで戻る**
   - `/setup/choose` に戻る

3. **「招待リンクで既存施設に参加する」ボタンをクリック**
   - `/setup/join` に遷移することを確認

**確認ポイント**:
- ✅ ボタンがクリック可能である
- ✅ 正しいページに遷移する

**記録**: ✅ ボタンが正しく動作する

---

## 📝 ステップ6: 他のページへのアクセスを確認（追加確認）

このステップでは、施設に紐付けられていないユーザーが、他の主要ページにアクセスした場合の動作を確認します。

### 6-1. `/clients` にアクセス

**手順**:

1. **ブラウザのアドレスバーに `/clients` を入力**
   - アドレスバーをクリック
   - `/clients` と入力
   - Enterキーを押す

2. **期待される動作を確認**
   - ✅ エラー画面が表示される、または
   - ✅ `/setup/choose` にリダイレクトされる、または
   - ✅ 空の一覧が表示される（RLSでフィルタリングされる）

**確認ポイント**:
- ✅ ホーム画面の内容が表示されていない
- ✅ エラーメッセージが表示されている、またはリダイレクトされている

**記録**: ✅ `/clients` にアクセスできない、または適切にブロックされる

---

### 6-2. `/groups` にアクセス

**手順**:

1. **ブラウザのアドレスバーに `/groups` を入力**
   - アドレスバーをクリック
   - `/groups` と入力
   - Enterキーを押す

2. **期待される動作を確認**
   - ✅ エラー画面が表示される、または
   - ✅ `/setup/choose` にリダイレクトされる、または
   - ✅ 空の一覧が表示される

**確認ポイント**:
- ✅ ホーム画面の内容が表示されていない
- ✅ エラーメッセージが表示されている、またはリダイレクトされている

**記録**: ✅ `/groups` にアクセスできない、または適切にブロックされる

---

### 6-3. `/settings` にアクセス

**手順**:

1. **ブラウザのアドレスバーに `/settings` を入力**
   - アドレスバーをクリック
   - `/settings` と入力
   - Enterキーを押す

2. **期待される動作を確認**
   - ✅ エラー画面が表示される、または
   - ✅ `/setup/choose` にリダイレクトされる

**確認ポイント**:
- ✅ 施設設定が表示されていない
- ✅ エラーメッセージが表示されている、またはリダイレクトされている

**記録**: ✅ `/settings` にアクセスできない、または適切にブロックされる

---

## 📝 ステップ7: 正常系の確認（対照実験）

このステップでは、**正常なユーザー（施設に紐付けられている）で、正常に動作する**ことを確認します。

### 7-1. 正常なユーザーでログイン

**手順**:

1. **ログアウト**
   - `/menu` にアクセス
   - 「ログアウト」をクリック

2. **正常なユーザーでログイン**
   - 施設に紐付けられている既存ユーザーでログイン
   - メールアドレスとパスワードを入力
   - 「ログイン」をクリック

**確認ポイント**:
- ✅ ログインが成功していること

**記録**: ✅ 正常なユーザーでログイン成功

---

### 7-2. SQLで正常なユーザーの状態を確認（オプション）

**手順**:

1. **Supabase Dashboard → SQL Editor**

2. **以下のSQLを実行**

```sql
-- 正常なユーザーの施設紐付けを確認
SELECT
  ufr.user_id,
  ufr.facility_id,
  f.name AS facility_name,
  ufr.role,
  ufr.deleted,
  ufr.created_at
FROM user_facility_roles ufr
JOIN facilities f ON f.id = ufr.facility_id
WHERE ufr.user_id = 'NORMAL_USER_ID_HERE'::uuid  -- 実際のユーザーIDに置き換える
  AND ufr.deleted = false;
```

3. **結果を確認**
   - ✅ 1行以上の結果が表示される（施設に紐付けられている）

**確認ポイント**:
- ✅ 結果が1行以上であること
- ✅ `facility_name` が表示されている

**記録**: ✅ 正常なユーザーは施設に紐付けられている

---

### 7-3. `/home` にアクセス

**手順**:

1. **ブラウザのアドレスバーに `/home` を入力**
   - アドレスバーをクリック
   - `/home` と入力
   - Enterキーを押す

2. **期待される動作を確認**
   - ✅ 正常にホーム画面が表示される
   - ✅ 施設名が表示される（ヘッダー部分）
   - ✅ 新着投稿などが表示される（データがあれば）
   - ✅ `/setup/choose` にリダイレクトされない

**確認ポイント**:
- ✅ ホーム画面が表示されている
- ✅ 施設名が表示されている
- ✅ リダイレクトされていない

**記録**: ✅ 正常なユーザーは `/home` にアクセスできる

---

## ✅ テスト結果のまとめ

### チェックリスト

以下のすべてに ✅ がつけば、テスト項目7は合格です：

- [ ] **ステップ2**: SQLで施設紐付けが無いことを確認（0件）
- [ ] **ステップ3**: テスト用ユーザーでログイン成功
- [ ] **ステップ4**: `/home` にアクセスすると `/setup/choose` にリダイレクトされる
- [ ] **ステップ4**: コンソールログに「User has no facilities, redirecting to setup」が表示される
- [ ] **ステップ5**: セットアップ画面が正しく表示される
- [ ] **ステップ6**: `/clients`, `/groups`, `/settings` でも適切にブロックされる
- [ ] **ステップ7**: 正常なユーザーは `/home` にアクセスできる

---

## 🔍 トラブルシューティング

### 問題1: リダイレクトされない

**症状**: 施設に紐付けられていないユーザーが `/home` にアクセスできる

**確認手順**:

1. **SQLで `user_facility_roles` を再確認**
   ```sql
   SELECT * FROM user_facility_roles
   WHERE user_id = 'TEST_USER_ID_HERE'::uuid
     AND deleted = false;
   ```
   - 結果が0件であることを確認

2. **ブラウザのコンソールログを確認**
   - `[HomePage] User has no facilities, redirecting to setup` が表示されているか確認

3. **Next.jsのターミナルログを確認**
   - 開発サーバーを起動しているターミナルで、サーバー側のログを確認

**対処方法**:
- `app/home/page.tsx` の158-161行目の実装を確認
- `redirect('/setup/choose')` が正しく呼び出されているか確認

---

### 問題2: セットアップ画面が表示されない

**症状**: `/setup/choose` にリダイレクトされたが、画面が表示されない

**確認手順**:

1. **`app/setup/choose/page.tsx` が存在するか確認**
   - ファイルが存在することを確認

2. **ブラウザのコンソールにエラーが表示されていないか確認**
   - 開発者ツールのConsoleタブでエラーメッセージを確認

3. **Next.jsのターミナルにエラーが表示されていないか確認**
   - 開発サーバーを起動しているターミナルでエラーログを確認

**対処方法**:
- `app/setup/choose/page.tsx` の実装を確認
- エラーログを確認して、問題を特定

---

### 問題3: 正常なユーザーもリダイレクトされる

**症状**: 施設に紐付けられているユーザーも `/setup/choose` にリダイレクトされる

**確認手順**:

1. **SQLで `user_facility_roles` を確認**
   ```sql
   SELECT * FROM user_facility_roles
   WHERE user_id = 'NORMAL_USER_ID_HERE'::uuid
     AND deleted = false;
   ```
   - 結果が1件以上であることを確認

2. **`app/home/page.tsx` の実装を確認**
   - `userFacilities` の取得処理が正しく動作しているか確認

**対処方法**:
- `app/home/page.tsx` の104-113行目の `userFacilities` 取得処理を確認
- `adminSupabase` クライアントが正しく使用されているか確認

---

## 📊 テスト結果記録用テンプレート

### テスト実施情報

- **実施日時**: _______________
- **実施者**: _______________
- **環境**: ☐ ローカル（localhost:3000） ☐ 本番（carebridge-hub-prod）
- **テスト用ユーザー（メール）**: _______________
- **テスト用ユーザー（ID）**: _______________

### テスト結果

| ステップ | 確認項目 | 結果 | 備考 |
|---------|---------|------|------|
| 2 | SQL: 施設紐付けが無いことを確認 | ☐ ✅ ☐ ❌ | |
| 3 | UI: テスト用ユーザーでログイン | ☐ ✅ ☐ ❌ | |
| 4 | UI: `/home` にリダイレクトされる | ☐ ✅ ☐ ❌ | |
| 4 | ログ: コンソールログが正しい | ☐ ✅ ☐ ❌ | |
| 5 | UI: セットアップ画面が表示される | ☐ ✅ ☐ ❌ | |
| 6 | UI: `/clients` でブロックされる | ☐ ✅ ☐ ❌ | |
| 6 | UI: `/groups` でブロックされる | ☐ ✅ ☐ ❌ | |
| 6 | UI: `/settings` でブロックされる | ☐ ✅ ☐ ❌ | |
| 7 | UI: 正常なユーザーは `/home` にアクセスできる | ☐ ✅ ☐ ❌ | |

### 発見された問題

1. **問題**: 
   - **現象**: 
   - **再現手順**: 
   - **対応**: 

---

## ✅ 合格判定

**テスト項目7の判定**: 上記のチェックリストのすべてに ✅ がつけば合格です！

---

## 🔗 関連ドキュメント

- [テスト項目7: UI側ガード実装確認 - 実施ガイド](./TEST7_UI_GUARD_GUIDE.md) - より詳細な技術的な説明
- [ユーザー招待：本番テスト用チェックリスト](./USER_INVITE_TEST_CHECKLIST.md) - 全体のテストチェックリスト

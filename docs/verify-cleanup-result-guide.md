# 削除結果の確認方法（手取り足取りガイド）

## 📋 確認用SQLとは？

`cleanup-test-data-option-a.sql` を実行した後、削除が正常に完了したかを確認するためのSQLです。

**確認する内容：**
1. 施設「RLS Policy Test」が削除されたか
2. 指定ユーザーの施設との関連付けが削除されたか
3. ユーザーアカウント自体は残っているか（オプションAでは残るべき）

---

## 🚀 実行手順（ステップバイステップ）

### ステップ1: Supabaseダッシュボードを開く

1. ブラウザで https://supabase.com にアクセス
2. ログイン（まだログインしていない場合）
3. プロジェクト「carebridge-hub-prod」を選択

### ステップ2: SQL Editorを開く

1. 左側のメニュー（サイドバー）から **「SQL Editor」** をクリック
   - データベースのアイコン（シリンダー状のアイコン）を探してください

### ステップ3: 新しいクエリを作成

1. SQL Editorが開いたら、上部の **「+ New query」** ボタンをクリック
   - または、既存のタブの横にある **「+」** ボタンをクリック

### ステップ4: 確認用SQLファイルを開く

1. ローカルのファイルシステムで以下のファイルを開く：
   ```
   docs/verify-cleanup-result.sql
   ```

2. ファイルの内容を全て選択してコピー（`Cmd + A` で全選択 → `Cmd + C` でコピー）

### ステップ5: SQL Editorに貼り付ける

1. Supabase SQL Editorのクエリ入力エリア（大きなテキストボックス）をクリック
2. コピーした内容を貼り付け（`Cmd + V`）

### ステップ6: SQLを実行

1. SQL Editorの右下にある **緑色の「Run」ボタン** をクリック
   - または、キーボードショートカット `Cmd + Enter` を押す

### ステップ7: 結果を確認

実行後、画面下部に結果が表示されます。以下の4つの結果セットが表示されるはずです：

#### 結果1: 施設の削除状態確認

**確認ポイント：**
- `deleted` 列が `true` になっているか
- `status` 列に `✅ 削除済み` と表示されているか

**正常な結果の例：**
```
id: [UUID]
name: RLS Policy Test
deleted: true
updated_at: [日時]
status: ✅ 削除済み
```

**異常な場合：**
- `deleted: false` の場合は削除されていません

---

#### 結果2: ユーザーの関連付け状態確認

**確認ポイント：**
- `status` 列に `✅ 削除済み` と表示されているか
- `⚠️ アクティブ（削除されていません）` と表示されていないか

**正常な結果の例：**
```
email: kanjinagatomi99@gmail.com
facility_name: RLS Policy Test
role: admin
status: ✅ 削除済み
```

**異常な場合：**
- `status` に `⚠️ アクティブ（削除されていません）` と表示されている場合は、削除が完了していません

---

#### 結果3: アクティブな関連付けの確認

**確認ポイント：**
- `active_count` が `0` になっているか
- `message` に `✅ 正常：アクティブな関連付けはありません` と表示されているか

**正常な結果の例：**
```
active_count: 0
message: ✅ 正常：アクティブな関連付けはありません
```

**異常な場合：**
- `active_count` が `0` より大きい場合は、まだアクティブな関連付けが残っています

---

#### 結果4: ユーザーアカウントの確認

**確認ポイント：**
- メールアドレス（`kanjinagatomi99@gmail.com` と `niversnagatomi@gmail.com`）が表示されているか
- `status` に `✅ ユーザーアカウントは残っています` と表示されているか

**正常な結果の例：**
```
email: kanjinagatomi99@gmail.com
created_at: [日時]
last_sign_in_at: [日時]
status: ✅ ユーザーアカウントは残っています
```

**異常な場合：**
- 結果が表示されない場合は、ユーザーアカウントが存在しません（オプションAでは通常は発生しません）

---

## ✅ 全ての結果が正常なら

全ての結果で ✅ マークが表示されていれば、削除は正常に完了しています。

次のステップ：新規施設作成のテスト（テスト項目0）に進むことができます。

---

## ⚠️ 異常が発見された場合

もし ⚠️ マークが表示されている場合は、以下を確認してください：

1. **エラーメッセージがないか確認**
   - SQL Editorの下部にエラーが表示されていないか確認

2. **SQLを再度実行**
   - `cleanup-test-data-option-a.sql` を再度実行してみてください

3. **手動で確認**
   - ステップ2のSQL（関連付け状態確認）で、どの関連付けが削除されていないか確認してください

---

## 📝 補足説明

### なぜ確認が必要なのか？

- **UPDATE文は結果を返さないことがある**
  - `UPDATE` 文を実行しても、実際に何件のレコードが更新されたかが分からない場合があります

- **誤って削除されていないか確認**
  - 間違ったデータが削除されていないか確認できます

- **削除が完全に完了したか確認**
  - 全ての関連付けが正しく削除されたか確認できます

### オプションAとオプションBの違い

- **オプションA（今回実行したもの）**
  - 施設とユーザーの関連付けのみ削除
  - ユーザーアカウント自体は残る
  - 結果4でユーザーアカウントが表示されるのが正常

- **オプションB（実行していない）**
  - ユーザーアカウント自体も完全に削除
  - 結果4で何も表示されないのが正常







# 全マイグレーション一括実行ガイド

## 概要

`docs/run-all-migrations.sql` には、001から064までのすべてのマイグレーションファイルが順番に結合されています。このファイルを1回実行するだけで、すべてのマイグレーションを適用できます。

## ファイル情報

- **ファイル名**: `docs/run-all-migrations.sql`
- **ファイルサイズ**: 約126KB
- **マイグレーション数**: 64個（001〜064）
- **総行数**: 約3,500行

## 使用方法

### ステップ 1: ファイルを開く

1. プロジェクトの `docs/run-all-migrations.sql` を開く
2. 内容をすべてコピー（Ctrl+A → Ctrl+C または Cmd+A → Cmd+C）

### ステップ 2: Supabase の SQL Editor で実行

1. Supabase Dashboard にアクセス
2. 本番プロジェクト（`carebridge-hub-prod`）を選択
3. 左メニューから **"SQL Editor"** をクリック
4. **"New query"** をクリック
5. コピーした内容を貼り付け（Ctrl+V または Cmd+V）

### ステップ 3: 実行

1. **"Run"** をクリック（または Ctrl+Enter / Cmd+Enter）
2. 実行が完了するまで待つ（数分かかる場合があります）

### ステップ 4: 結果の確認

1. **エラーがない場合**:
   - 最後のクエリの結果が表示されます
   - 一部のマイグレーションファイルには検証クエリ（SELECT文）が含まれているため、結果が表示されることがありますが、これは正常です

2. **エラーが発生した場合**:
   - エラーメッセージを確認
   - エラーメッセージに表示されている行番号から、どのマイグレーションでエラーが発生したかを特定
   - ファイル内のコメント（`-- Migration: XXX_xxx.sql`）を確認して、該当するマイグレーションファイルを特定

## 注意事項

### 1. 実行時間

- すべてのマイグレーションを実行するには、数分かかる場合があります
- 実行中はブラウザを閉じないでください

### 2. 検証クエリ

- 一部のマイグレーションファイル（例: `006_verify_policies.sql`, `018_verify_permissions.sql`）には検証クエリ（SELECT文）が含まれています
- 検証クエリの結果が表示されますが、これはエラーではありません
- 検証クエリの結果は、マイグレーションが正しく適用されたことを確認するためのものです

### 3. エラーハンドリング

- エラーが発生した場合、エラーメッセージを確認してください
- エラーメッセージに表示されている行番号から、どのマイグレーションでエラーが発生したかを特定できます
- ファイル内のコメント（`-- Migration: XXX_xxx.sql`）を確認して、該当するマイグレーションファイルを特定してください

### 4. 既存のデータ

- このマイグレーションは、既存のデータベースに適用されます
- 一部のマイグレーションは、既存のテーブルやポリシーを変更する可能性があります
- 本番環境で実行する前に、バックアップを取ることを推奨します

## トラブルシューティング

### エラー: "relation already exists"

- このエラーは、テーブルや関数が既に存在する場合に発生します
- 多くのマイグレーションファイルは `IF NOT EXISTS` や `DROP IF EXISTS` を使用しているため、通常は問題ありません
- エラーが発生した場合は、該当するマイグレーションファイルを個別に確認してください

### エラー: "permission denied"

- このエラーは、権限が不足している場合に発生します
- `017_grant_permissions_to_anon_role.sql` などの権限付与マイグレーションが正しく実行されているか確認してください

### エラー: "syntax error"

- このエラーは、SQL構文エラーの場合に発生します
- エラーメッセージに表示されている行番号から、どのマイグレーションでエラーが発生したかを特定してください

## 個別実行との比較

### 一括実行のメリット

- ✅ 1回の実行で完了
- ✅ 時間の節約
- ✅ 手順が簡単

### 個別実行のメリット

- ✅ 各マイグレーションの結果を個別に確認できる
- ✅ エラーが発生した場合、どのマイグレーションでエラーが発生したかが明確
- ✅ 一部のマイグレーションをスキップできる

## 推奨事項

- **初回実行**: 一括実行（`docs/run-all-migrations.sql`）を使用
- **エラーが発生した場合**: 個別実行に切り替えて、エラーが発生したマイグレーションから個別に実行
- **特定のマイグレーションのみ実行**: 該当するマイグレーションファイルを個別に実行

## 次のステップ

マイグレーションの実行が完了したら、以下を確認してください：

1. **テーブルの確認**:
   - Supabase Dashboard → Database → Tables
   - 必要なテーブルが存在することを確認

2. **マイグレーション履歴の確認**:
   - Supabase Dashboard → Database → Migrations
   - マイグレーション履歴が表示されることを確認

3. **アプリケーションの動作確認**:
   - ログイン画面で無限ループが発生しないか確認
   - 各機能が正常に動作するか確認











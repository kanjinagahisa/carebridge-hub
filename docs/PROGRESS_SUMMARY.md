# ユーザー招待機能：実装・修正進捗状況

**最終更新**: 2025年12月12日

---

## 📊 実装状況サマリー

### ✅ 実装完了（コードレベル）

| 項目 | 実装状況 | 備考 |
|------|---------|------|
| 1. 招待リンク作成機能 | ✅ 完了 | `/settings/facility/invite` で実装済み |
| 2. 招待リンクアクセス機能 | ✅ 完了 | `/invite/[code]` で実装済み |
| 3. 招待受け入れ機能 | ✅ 完了 | 既参加ユーザーの検出・処理も実装済み |
| 4. 施設ロール付与 | ✅ 完了 | `user_facility_roles` への挿入処理実装済み |
| 5. 使用済み招待リンク処理 | ✅ 完了 | 既参加ユーザーへの適切なメッセージ表示 |
| 6. UI側ガード | ✅ 完了 | `/setup/choose` での既参加ユーザー自動リダイレクト |
| 7. ハイドレーションエラー修正 | ✅ 完了 | `TabBar` と `NewPostSummaryCard` を修正 |

### ⏳ テスト未実施（実際の動作確認が必要）

| 項目 | テスト状況 | 次のアクション |
|------|----------|--------------|
| 1. 招待リンク作成の動作確認 | ⏳ 未実施 | 実際にUIで操作して確認 |
| 2. SQLでのデータ確認 | ⏳ 未実施 | チェックリストのSQLを実行 |
| 3. 権限境界テスト | ⏳ 未実施 | 招待ユーザーでログインして確認 |
| 4. client-documents動作確認 | ⏳ 未実施 | 招待ユーザーでアップロード・削除を確認 |

---

## 🎯 チェックリスト項目別の詳細状況

### 1. 招待リンクが作成されたか（招待リンク作成〜共有）

#### 実装状況
- ✅ **UI実装**: `/app/settings/facility/invite/page.tsx` に実装済み
  - 招待ロール選択（一般職員/管理者）
  - 招待メッセージ入力（任意）
  - 「招待リンクを作成」ボタン
  - 招待リンク表示とコピーボタン
  - リンク形式: `https://carebridge-hub.vercel.app/invite/{code}`

#### テストが必要な項目
- [ ] 実際にUIで操作して動作確認
- [ ] SQLで `invite_codes` テーブルにレコードが作成されることを確認
- [ ] 招待コードがUUID形式で生成されることを確認
- [ ] 有効期限が48時間後に設定されることを確認

---

### 2. 招待リンクにアクセスできるか（招待リンクの有効性確認）

#### 実装状況
- ✅ **UI実装**: `/app/invite/[code]/page.tsx` に実装済み
  - 未ログイン状態でのアクセス対応
  - 施設名の表示
  - 「ログインして承認する」ボタン（未ログインの場合）
  - 使用済み/期限切れ/キャンセル済みの検出とメッセージ表示
  - 既参加ユーザーの検出と適切なメッセージ表示

#### テストが必要な項目
- [ ] 実際に招待リンクにアクセスして動作確認
- [ ] SQLで招待コードの状態を確認
- [ ] 期限切れ/使用済み/キャンセル済みの各ケースで適切に動作するか確認

---

### 3. 招待リンクを使用してユーザーが参加できるか（招待受け入れ〜ユーザー作成）

#### 実装状況
- ✅ **UI実装**: `/app/invite/[code]/page.tsx` に実装済み
  - ログインページへのリダイレクト（`/login?redirect=/invite/{code}`）
  - ログイン後の招待受け入れページへの復帰
  - 「参加する」ボタン
  - 参加完了メッセージ表示
  - ホーム画面への自動遷移（1秒後）

#### テストが必要な項目
- [ ] 実際に招待リンクを使用して参加フローを確認
- [ ] 新規ユーザーと既存ユーザーの両方で動作確認
- [ ] SQLで `auth.users` と `user_facility_roles` に正しくデータが作成されることを確認

---

### 4. アプリ側の「施設ロール付与」ができているか（最重要）

#### 実装状況
- ✅ **実装済み**: `/app/invite/[code]/page.tsx` の `handleAccept` 関数
  - `user_facility_roles` への挿入処理
  - 重複チェック（既に所属している場合はエラー表示）
  - 招待コードの `used` フラグ更新

#### テストが必要な項目
- [ ] SQLで `user_facility_roles` に正しくレコードが作成されることを確認
- [ ] `role` が招待コードで指定したロールと一致することを確認
- [ ] `deleted = false` であることを確認
- [ ] 招待コードの `used = true` になることを確認

---

### 5. "見えるべきものだけ"見えるか（権限境界テスト）

#### 実装状況
- ✅ **RLS実装**: `supabase/migrations/002_rls_policies.sql` に実装済み
  - 自施設のデータのみ表示されるRLSポリシー
  - 他施設のデータは見えない

#### テストが必要な項目
- [ ] 招待ユーザーでログインして `/clients` にアクセス
- [ ] 自施設の利用者一覧が見えることを確認
- [ ] 他施設の利用者が見えないことを確認（他施設データが存在する場合）

---

### 6. client-documents が「招待ユーザーでも」想定通りか

#### 実装状況
- ✅ **Storage RLS実装**: 既存の実装（確認が必要）
  - アップロード機能
  - 一覧表示機能
  - 削除機能
  - RLSポリシーによる他施設データの非表示

#### テストが必要な項目
- [ ] 招待ユーザーでログインして書類アップロードを実行
- [ ] 一覧に表示されることを確認
- [ ] 削除できることを確認
- [ ] 他施設の利用者IDに対しては見えない/操作できないことを確認
- [ ] SQLで `storage.objects` に正しく保存されることを確認

---

### 7. ✅ 事故りにくくする「任意の＋1点」（UI側ガード）

#### 実装状況
- ✅ **実装完了**: `/app/setup/choose/page.tsx`
  - 既に施設に所属しているユーザーを検出
  - 自動的に `/home` にリダイレクト
  - 施設に所属していない場合のみセットアップ画面を表示

#### テストが必要な項目
- [ ] 既参加ユーザーでログインして `/setup/choose` にアクセス
- [ ] 自動的に `/home` にリダイレクトされることを確認

---

## 📝 次のステップ（テスト実施）

### ステップ1: 事前準備
1. **FACILITY_ID** を決定（テスト用の施設ID）
2. **INVITER_EMAIL** を決定（管理者のメールアドレス）

### ステップ2: 招待リンク作成のテスト
1. `/settings/facility/invite?facility_id={FACILITY_ID}` にアクセス
2. 招待ロールを選択
3. 「招待リンクを作成」ボタンをクリック
4. 招待リンクが表示されることを確認
5. SQLで `invite_codes` テーブルを確認

### ステップ3: 招待リンク使用のテスト
1. 別ブラウザ（またはプライベートモード）で招待リンクにアクセス
2. ログイン（または新規サインアップ）
3. 「参加する」ボタンをクリック
4. ホーム画面に遷移することを確認
5. SQLで `user_facility_roles` を確認

### ステップ4: 権限境界テスト
1. 招待ユーザーでログイン
2. `/clients` にアクセス
3. 自施設の利用者のみ表示されることを確認

### ステップ5: client-documents テスト
1. 招待ユーザーでログイン
2. 利用者の書類アップロードを実行
3. 一覧表示・削除を確認

---

## 🔍 トラブルシューティング

問題が発生した場合は、チェックリストの「付録：トラブルが出た時の切り分け順」を参照してください。

1. `invite_codes` に招待コードが作成されているか
2. 招待リンクが有効か（期限切れ/使用済み/キャンセル済みでないか）
3. `auth.users` にユーザーがいるか
4. `user_facility_roles` に紐付いているか
5. UIで `/clients` が見えるか
6. `storage.objects` に正しく保存されているか

---

## ✅ 完了条件

すべてのテスト項目にチェックが入れば、ユーザー招待機能の実装とテストは完了です。

- [ ] 招待リンクが正しく作成される
- [ ] 招待リンクが有効である（期限切れ/使用済み/キャンセル済みでない）
- [ ] 招待リンクを使用してユーザーが参加できる
- [ ] 施設ロールが正しく付与される
- [ ] 権限境界が正しく機能する
- [ ] client-documents が正しく動作する
- [ ] UI側ガードが実装されている（✅ 実装済み）







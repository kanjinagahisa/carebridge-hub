# HEIC/MP4/MOV ファイル選択問題のトラブルシューティング

## 🔧 実施した修正

### 1. `accept` 属性の最適化

`components/client/ClientDocumentsCard.tsx` の `accept` 属性を以下のように修正しました：

**変更前**:
```typescript
accept=".pdf,.jpg,.jpeg,.png,.heic,.heif,.doc,.docx,.mp4,.mov,image/*,video/*,application/pdf"
```

**変更後**:
```typescript
accept="image/*,video/*,application/pdf,.pdf,.jpg,.jpeg,.png,.heic,.heif,.mp4,.mov,.doc,.docx"
```

**変更内容**:
- `image/*` と `video/*` を最初に配置（ワイルドカードを優先）
- その後で拡張子を明示的に指定
- これにより、より多くのファイルタイプが選択可能になります

---

## ⚠️ 問題が解決しない場合の対処法

### 1. ブラウザのキャッシュをクリア

**最も重要な対処法**: ブラウザのキャッシュが古いコードを保持している可能性があります。

#### Chrome / Edge の場合

1. **ハードリロード**
   - `Cmd+Shift+R` (Mac) または `Ctrl+Shift+R` (Windows/Linux)
   - または、開発者ツールを開いた状態でリロードボタンを右クリック → 「キャッシュの消去とハード再読み込み」

2. **キャッシュを完全にクリア**
   - `Cmd+Shift+Delete` (Mac) または `Ctrl+Shift+Delete` (Windows/Linux)
   - 「キャッシュされた画像とファイル」を選択
   - 「データを消去」をクリック

#### Safari の場合

1. **開発メニューを有効化**（まだの場合）
   - Safari → 環境設定 → 詳細 → 「メニューバーに"開発"メニューを表示」にチェック

2. **キャッシュをクリア**
   - 開発 → キャッシュを空にする
   - または、`Cmd+Option+E`

3. **ハードリロード**
   - `Cmd+Option+R`

---

### 2. 別のブラウザで試す

ブラウザによって `accept` 属性の解釈が異なる場合があります。

**推奨ブラウザ**:
- **Safari**（macOS）: HEIC ファイルのサポートが最も良好
- **Chrome**: 一般的に広く使用されている
- **Firefox**: 別の実装を使用しているため、動作が異なる場合がある

---

### 3. ブラウザの開発者ツールで確認

1. **開発者ツールを開く**
   - `F12` または `Cmd+Option+I` (Mac) / `Ctrl+Shift+I` (Windows)

2. **Elements タブで確認**
   - ファイル入力要素を検索
   - `accept` 属性が正しく設定されているか確認

3. **Console タブで確認**
   - エラーメッセージがないか確認
   - ファイル選択時にエラーが発生していないか確認

---

### 4. HEIC ファイルについての特別な注意

**HEIC ファイルの制限**:
- HEIC は Apple の画像形式で、多くのブラウザ（特に Safari 以外）では完全にサポートされていません
- macOS のファイル選択ダイアログでは表示されても、ブラウザがそれを認識しない場合があります

**対処法**:
1. **Safari ブラウザを使用する**（最も確実）
2. **HEIC ファイルを JPEG/PNG に変換してからアップロードする**
   - macOS の「写真」アプリで変換可能
   - または、オンラインツールを使用

---

### 5. 動画ファイル（MP4/MOV）について

**MP4 ファイル**:
- 一般的に広くサポートされている形式
- ほとんどのブラウザで選択可能なはずです

**MOV ファイル**:
- QuickTime 形式で、macOS では標準的
- 一部のブラウザではサポートが限定的な場合があります

**対処法**:
- MP4 ファイルは問題なく動作するはずです
- MOV ファイルが選択できない場合は、MP4 に変換することを検討してください

---

## 🔍 デバッグ手順

### ステップ1: ブラウザのコンソールで確認

1. 開発者ツールを開く（`F12` または `Cmd+Option+I`）
2. Console タブを開く
3. 「書類を追加」ボタンをクリック
4. ファイル選択ダイアログを開く
5. コンソールにエラーが表示されていないか確認

### ステップ2: ネットワークタブで確認

1. 開発者ツールの Network タブを開く
2. 「書類を追加」ボタンをクリック
3. ファイルを選択してアップロードを試みる
4. リクエストが送信されているか確認
5. エラーレスポンス（400, 403 など）がないか確認

### ステップ3: 実際のファイルでテスト

1. **PNG ファイル**: 既に動作確認済み ✅
2. **PDF ファイル**: 既に動作確認済み ✅
3. **MP4 ファイル**: テストが必要
4. **MOV ファイル**: テストが必要
5. **HEIC ファイル**: テストが必要（Safari で推奨）

---

## 📝 確認用チェックリスト

- [ ] ブラウザのキャッシュをクリアした
- [ ] ハードリロード（`Cmd+Shift+R` / `Ctrl+Shift+R`）を実行した
- [ ] 別のブラウザで試した（Safari、Chrome、Firefox）
- [ ] 開発者ツールの Console でエラーを確認した
- [ ] 開発者ツールの Network タブでリクエストを確認した
- [ ] 実際に MP4 ファイルでアップロードを試した
- [ ] 実際に MOV ファイルでアップロードを試した
- [ ] 実際に HEIC ファイルでアップロードを試した（Safari 推奨）

---

## 🎯 期待される動作

### 正常な動作

1. **ファイル選択ダイアログ**
   - HEIC、MP4、MOV ファイルが選択可能（グレーアウトされていない）
   - 「開く」ボタンが有効になる

2. **アップロード**
   - エラーメッセージが表示されない
   - 「アップロード中...」の表示が消える
   - 書類一覧に新しいファイルが表示される

3. **ブラウザのコンソール**
   - エラーメッセージが表示されない
   - Network タブでリクエストが成功（ステータスコード 200 または 201）

---

## 💡 追加の対処法

### もし問題が解決しない場合

1. **Vercel のデプロイを確認**
   - 最新のコードがデプロイされているか確認
   - Vercel Dashboard で最新のデプロイメントを確認

2. **コードの確認**
   - `components/client/ClientDocumentsCard.tsx` の `accept` 属性が正しく設定されているか確認
   - ブラウザの開発者ツールで実際の HTML を確認

3. **Storage バケット設定の再確認**
   - Supabase Dashboard で `allowed_mime_types` が `["application/pdf", "image/*", "video/*"]` になっているか確認

---

## 📞 サポート

問題が解決しない場合は、以下を確認してください：

1. 使用しているブラウザとバージョン
2. 開発者ツールの Console に表示されているエラーメッセージ
3. Network タブで確認したリクエストの詳細
4. 実際に試したファイルの種類とサイズ





